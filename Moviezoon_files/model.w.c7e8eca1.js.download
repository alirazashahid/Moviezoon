define(["require","exports","./shared.w.f83982bb","OK/logger","OK/webapi","OK/pts!music.app"],(function(t,e,r,i,s,n){"use strict";function a(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var o=new Map;function u(t,e,r){var i=o.get(e);return i||(i=c(t,e,r).then((function(t){return o.delete(e),t})).catch((function(t){throw o.delete(e),t})),o.set(e,i)),i}function c(t,e,r,i){return void 0===i&&(i=1),function(t,e,r){return new Promise((function(i,s){var n=new XMLHttpRequest;n.open(t,e),n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),r||n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onerror=function(){return s(new Error("error.network"))},n.onload=function(){if(200===n.status)try{var t=JSON.parse(n.responseText),e=null==t?void 0:t.error;e?s(new Error(e)):i(t)}catch(t){s(t)}else{if(!n.statusText)try{var r=JSON.parse(n.responseText);r&&s(new Error(r.reason))}catch(t){s(new Error(n.statusText))}s(new Error(n.statusText))}},n.send(r)}))}(t,e,r).catch((function(s){if("error.network"!==(n=s).message&&"error.service.not.available"!==n.message&&"error.tuners.unavailable"!==n.message||i>=10)throw s;var n;return new Promise((function(s,n){setTimeout((function(){return c(t,e,r,++i).then(s,n)}),1e3)}))}))}function l(t,e){i.duration("music.api.request",Math.round(performance.now()-t),e)}var d,p=function(){function t(t){void 0===t&&(t="ru"),this.locale=t}return t.getCredentials=function(){return s.invoke("music/conf")},t.prototype.get=function(t,e){return this.request("GET",t,e)},t.prototype.post=function(t,e){return e&&e instanceof FormData?this.request("POST",t,void 0,e):this.request("POST",t,e)},t.prototype.createURL=function(e,r){var i=this;return this.credentials||(this.credentials=t.getCredentials()),this.credentials.then((function(t){if(0===e.indexOf("https://"))return"".concat(e,";jsessionid=").concat(t.sid);var s=0===e.indexOf("upload/")?"".concat(t.uploadHost,"/api/v1"):t.apiHost;return"".concat(s,"/").concat(e,";jsessionid=").concat(t.sid).concat(i.stringifyParams(r,t.bci))}))},t.prototype.request=function(t,e,s,n){var a=this,o=performance.now();return this.createURL(e,s).then((function(e){return u(t,e,n)})).then((function(t){return l(o,e),t})).catch((function(u){if(l(o,e),"error.notloggedin"===u.message)return a.credentials=void 0,a.request(t,e,s,n);throw function(t,e,s,n){if(r.isASignificantError(t)){var a="params: ".concat(s?JSON.stringify(s):"<empty>","\ndata: ").concat(n?"yes":"no","\n").concat(Error().stack);return i.clob("music.api.error",a,e,t.message)}i.success("music.api.error",e,t.message)}(u,e,s,n),u}))},t.prototype.stringifyParams=function(t,e){void 0===t&&(t={});for(var r=this.addParams(t,e),i=[],s=0,n=Object.keys(r);s<n.length;s++){var a=n[s],o=r[a];this.isNotEmpty(o)&&i.push("".concat(a,"=").concat(encodeURIComponent(String(r[a]))))}return"?"+i.join("&")},t.prototype.isNotEmpty=function(t){return null!=t&&""!==t},t.prototype.addParams=function(t,e){return void 0===t&&(t={}),t.client="web",t.locale=this.locale,t.imgfmt="base",t.bci=e,t},t}(),h=function(){function t(){this.listeners={}}return t.prototype.on=function(t,e){var r=this.listeners[t];return r||(r=[],this.listeners[t]=r),r.push(e),this},t.prototype.emit=function(t,e){if(!this.emittingIsNotAllowed()){var r=this.listeners[t];r&&r.forEach((function(t){return t(e)}))}},t}(),f="postroll";function y(e,r,i){return d?(d("user-skip"),Promise.resolve()):i?new Promise((function(s,n){d=n,new Promise((function(e,r){t(["adman"],(function(t){e(a(t))}),r)})).then((function(){var t=window.AdmanHTML;if(t)return new t})).then((function(t){if(!t)return s();t.init(function(t,e){return{slot:3564,audioEl:t,params:{t:m(),_SITEID:163,content_id:e.trackId,duration:e.duration,ok_id:e.userId,ok_catid:e.categoryId,puid22:e.genre,account_age_type:e.userType},wrapper:document.documentElement,browser:{}}}(e,i)),t.onReady((function(i){var n=t.getBannersForSection(f);if(n&&n.length){!function(t){if(t&&t.settings&&t.settings[f]){var e=t.settings[f];e.maxBannersShow>1&&k("mbs"),e.loop&&k("loop")}}(i),e.loop&&(e.loop=!1),t.start(f);var a=n[0].adChoices;r.emit(7,function(t){var e=null==t?void 0:t.options;if(!e)return;var r=e.find((function(t){return"copy"===t.type})),i=e.find((function(t){return t.clickLink}));return{copy:r,about:i}}(a))}else k("skip"),s("skip")})),t.onStarted((function(){k("started")})),t.onError((function(e){k("error",null==e?void 0:e.message),t.stop(),r.emit(8),s(e)})),t.onTimeRemained((function(t){r.emit(9,{duration:t.duration,currentTime:t.currentTime})})),t.onCompleted((function(){r.emit(8),k("finished"),s()}))})).catch((function(t){console.error("error while playing ads",t),r.emit(8),s()}))})).then((function(){d=void 0})):Promise.resolve()}function m(){if("function"==typeof window.getAdvTargetParam)return encodeURIComponent(window.getAdvTargetParam())}function g(t){switch(t){case 10:return"my";case 8:return"pop";case 14:return"personalpl";case 1:return"album";case 11:return"artist";case 19:return"myRadio";default:return"unknown"}}function k(t,e){i.success("music.ads",t,e)}var v=null;function b(){v&&clearTimeout(v)}var _=function(e){function s(t,r){var s=e.call(this)||this;return s.isMediaAttachToHls=!1,s.audio=t,s.fakeAudio=r,s.startTime=0,s.animateVolume=!1,s.lastVolume=s.audio.volume,s.audio.addEventListener("pause",(function(){return s.emit(2)})),s.audio.addEventListener("play",(function(){return s.emit(1)})),s.audio.addEventListener("waiting",(function(){return s.emit(3,!0)})),s.audio.addEventListener("playing",(function(){return s.emit(3,!1)})),s.audio.addEventListener("progress",(function(){var t=s.getCached();t&&(s.startTime>0&&(i.duration("music",Date.now()-s.startTime,"player","cache-ttfb"),s.startTime=0),s.emit(4,{cached:t}))})),s.audio.addEventListener("suspend",(function(){1===s.audio.networkState&&(s.getCached()/s.audio.duration>.9&&s.emit(4,{cached:s.audio.duration}))})),s.audio.addEventListener("timeupdate",(function(){s.emit(5,{duration:s.audio.duration,currentTime:s.audio.currentTime})})),s.audio.addEventListener("ended",(function(){s.emit(6)})),s.audio.addEventListener("error",(function(){s.audio.src&&0!==s.audio.src.indexOf("data:audio/mpeg;base64")&&s.emit(0,s.audio.error)})),s}return r.__extends(s,e),Object.defineProperty(s.prototype,"currentSrc",{get:function(){var t=this.audio.currentSrc;return 0===t.indexOf("data:audio")?"":t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"playing",{get:function(){return!this.audio.paused},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"currentTime",{get:function(){return this.audio.currentTime},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"volume",{get:function(){return this.audio.volume},set:function(t){var e=t/100;this.audio.volume=e,this.lastVolume=e},enumerable:!1,configurable:!0}),s.prototype.play=function(t,e){var r=this;this.restoreVolume(),this.srcAfterAd?this.srcAfterAd=t:e?(this.srcAfterAd=t,y(this.audio,this,e).then((function(){r.play0(r.srcAfterAd),r.srcAfterAd=void 0}))):this.play0(null!=t?t:this.fakeAudio)},s.prototype.pause=function(){var t,e,r;this.audio.paused||(this.animateVolume=!0,t=this.audio,e=Date.now(),r=function(){var i=Date.now(),s=Math.max(0,t.volume-(i-e)/250);t.volume=s,e=i,t.volume>0&&s===t.volume?v=setTimeout(r,1):t.pause()},b(),r(),this.emit(3,!1))},s.prototype.resume=function(){var t=this;return this.audio.paused?this.audio.src?this.play0().then((function(){var e,i,s,n;t.animateVolume&&!r.Env.isMobileApp&&(e=t.audio,i=t.lastVolume,s=Date.now(),n=function(){var t=Date.now();e.volume=Math.min(i,e.volume+(t-s)/250),s=t,e.volume<i&&(v=setTimeout(n,1))},b(),e.volume=0,n())})):Promise.reject("no-src"):Promise.resolve()},s.prototype.seek=function(t){var e=this.audio.currentTime;this.restoreVolume(),this.audio.currentTime=t,this.emit(10,{from:e,to:t})},s.prototype.emittingIsNotAllowed=function(){return this.audio.src===this.fakeAudio},s.prototype.getHLSInstance=function(){return this.httpLiveStreamingInstance||(this.httpLiveStreamingInstance=this.getHLSConstructor().then((function(t){return new t}))),this.httpLiveStreamingInstance},s.prototype.getHLSConstructor=function(){return this.httpLiveStreamingConstructor||(this.httpLiveStreamingConstructor=new Promise((function(e,r){t(["./hls.w.dc5adb7f"],e,r)})).then((function(t){return t.default}))),this.httpLiveStreamingConstructor},s.prototype.playHLS=function(t){var e=this;return Promise.all([this.getHLSConstructor(),this.getHLSInstance()]).then((function(r){var i=r[0],s=r[1];return new Promise((function(r,n){i.isSupported()||n(),s.loadSource(t),s.attachMedia(e.audio),e.isMediaAttachToHls=!0,s.once(i.Events.MANIFEST_PARSED,(function(){e.audio.play().then((function(){e.startTime=Date.now(),r()}))}))}))}))},s.prototype.play0=function(t){var e,r=this;if(t){if(function(t){return!!t&&"string"==typeof t&&(t.endsWith(".m3u")||t.endsWith(".m3u8"))}(t))return this.playHLS(t);e=(this.isMediaAttachToHls?this.detachHls():Promise.resolve()).then((function(){r.startTime=Date.now(),r.audio.src=t}))}return Promise.resolve(e).then((function(){return r.audio.play()}))},s.prototype.detachHls=function(){var t=this;return this.getHLSInstance().then((function(e){e.detachMedia(),t.isMediaAttachToHls=!1}))},s.prototype.restoreVolume=function(){this.animateVolume&&(this.animateVolume=!1,this.audio.volume=this.lastVolume)},s.prototype.getCached=function(){var t=this.audio.buffered;return t.length?t.end(t.length-1):0},s}(h);var T="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV////////////////////////////////////////////AAAAAExhdmM1OC4xMwAAAAAAAAAAAAAAACQDkAAAAAAAAAGw9wrNaQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAAAAANIAAAAAExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV/+MYxDsAAANIAAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV/+MYxHYAAANIAAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";function A(t){if(!t)return 0;if("string"==typeof t){var e=Number(t);if(!isNaN(e))return e;switch(t){case"pop":return 8;case"album":return 1;case"artist":return 11;case"playlist":return 14;case"personal":return 10;case"friend":return 4}return 0}return t}var w={playing:!1,loading:!1,queue:{type:0,tracks:r.ChunkedList.loading()},currentTime:0,duration:0,cached:0,volume:100,hasRadio:!1,lyricsIsOpen:!1,muted:!1,repeat:"off",ad:!1},P=function(){function t(t){this.state=t||w,this.subscribers=[]}return Object.defineProperty(t.prototype,"playing",{get:function(){return this.state.playing},set:function(t){this.state.playing!==t&&(this.state.playing=t,this.notify())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loading",{get:function(){return this.state.loading},set:function(t){this.state.loading!==t&&(this.state.loading=t,this.notify())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTrackSrc",{get:function(){return this.state.currentTrackSrc},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"radioStation",{get:function(){return this.state.radioStation},set:function(t){this.state.radioStation=t,this.state.loading=!0,this.notify()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"track",{get:function(){return this.state.track},set:function(t){var e;(null==t?void 0:t.id)!==(null===(e=this.state.track)||void 0===e?void 0:e.id)&&this.state.lyricsIsOpen&&(this.state.lyricsIsOpen=!1),this.state.track=t,this.state.ad||(this.state.cached=-1,this.state.currentTime=-1),this.state.loading=!0,this.notify()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"user",{get:function(){return this.state.user},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"queue",{get:function(){return this.state.queue},set:function(t){this.state.queue=t,this.notify()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"repeat",{get:function(){return this.state.repeat},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this.state.volume},set:function(t){this.state.volume=t,this.state.muted=!1,this.notify()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.state.currentTime},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){return this.state.currentTime},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cached",{get:function(){return this.state.cached},set:function(t){-1!==this.state.cached&&(this.state.cached=t,this.notify())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ad",{get:function(){return this.state.ad},set:function(t){this.state.ad=t,this.state.adOptions=void 0,this.notify()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return this.state.muted},set:function(t){this.state.muted=t,this.notify()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasRadio",{get:function(){return this.state.hasRadio},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lyricsIsOpen",{get:function(){return this.state.lyricsIsOpen},set:function(t){this.state.lyricsIsOpen=t,this.notify()},enumerable:!1,configurable:!0}),t.prototype.playRadio=function(t){this.state.radioStation=t,this.state.track=void 0,this.state.ad||(this.state.cached=0,this.state.currentTime=0,this.state.duration=0),this.state.user=void 0,this.state.hasRadio=!1,this.state.lyricsIsOpen=!1,this.notify()},t.prototype.play=function(t,e,r,i){var s,n=null===(s=this.state.track)||void 0===s?void 0:s.id;this.state.ad||(this.state.cached=0,this.state.currentTime=0,this.state.duration=V(t)),this.state.radioStation=void 0,this.state.currentTrackSrc=i,this.state.track=t,this.state.user=e,this.state.hasRadio=r,n!==t.id&&(this.state.lyricsIsOpen=!1),this.notify()},t.prototype.updateTime=function(t){var e=t.currentTime,r=t.duration;-1!==this.state.currentTime&&(this.state.currentTime=e,this.state.duration=r||V(this.state.track),this.notify())},t.prototype.startAd=function(t){this.state.ad=!0,this.state.playing=!0,t&&(this.state.adOptions=t),this.notify()},t.prototype.updateAdTime=function(t){this.state.ad&&this.updateTime(t)},t.prototype.toggleRepeat=function(){this.state.repeat=function(t){switch(t){case"off":return"all";case"all":return"one";default:return"off"}}(this.state.repeat),this.notify()},t.prototype.rewind=function(){var t=this.state.queue.tracks.items[0];this.state.currentTrackSrc=void 0,this.state.track=t,this.state.playing=!1,this.state.currentTime=0,this.state.cached=0,this.state.duration=V(t),this.notify()},t.prototype.setQueueLoading=function(t){this.queue0({tracks:this.queue.tracks.setLoading(t)})},t.prototype.updateQueue=function(t,e){this.state.track=t,this.state.queue=e,this.state.ad||(this.state.duration=V(t),this.state.currentTime=0,this.state.cached=0),this.notify()},t.prototype.addTrack=function(t){var e=this.state,i=e.track,s=e.queue;if(!i||s.tracks.isEmpty)return this.state.track=t,void(this.queue={tracks:r.ChunkedList.of([t]),type:27,id:String(t.id)});if(i.id!==t.id){var n=s.tracks,a=n.items;this.removeTrackIfContains(t,a);var o=s.originalTracks,u=a.indexOf(i);o&&(this.removeTrackIfContains(t,o.items),o.items.push(t)),-1!==u?(a.splice(u+1,0,t),this.queue0({tracks:n.setItems(a)})):this.queue0({tracks:n.setItems(r.__spreadArray([t],a,!0))})}},t.prototype.addPlaylistToQueue=function(t,e){var i,s,n=this,a=this.state,o=a.track,u=a.queue,c=u.tracks,l=c.items,d=u.originalTracks;if(u.tracks.isEmpty)return o||(this.state.track=t[0]),void this.queue0({tracks:r.ChunkedList.of(t),id:String(e.id),type:A(e.type)});t.forEach((function(t){return n.removeTrackIfContains(t,l)}));var p=l.indexOf(o);-1!==p?(d&&(t.forEach((function(t){return n.removeTrackIfContains(t,d.items)})),(i=d.items).push.apply(i,t)),(s=c.items).splice.apply(s,r.__spreadArray([p+1,0],t,!1)),this.queue0({tracks:c})):this.queue0({tracks:c.setItems(r.__spreadArray(r.__spreadArray([],t,!0),l,!0))})},t.prototype.removeTrack=function(t){var e=this.state.queue.tracks,r=e.items.indexOf(t);if(r>-1){var i=e.items.slice();i.splice(r,1),this.queue0({tracks:e.setItems(i)})}},t.prototype.reorderTrack=function(t,e){var r=this.state.queue,i=r.tracks.items.slice(),s=i.indexOf(t);i.splice(s,1),i.splice(e,0,t),this.queue0({tracks:r.tracks.setItems(i)})},t.prototype.getCurrentIndex=function(){var t=this.state,e=t.track,r=t.queue;return e?r.tracks.items.indexOf(e):-1},t.prototype.subscribe=function(t){var e=this;return this.subscribers.push(t),t(this.state),function(){var r=e.subscribers.indexOf(t);r>=0&&e.subscribers.splice(r,1)}},t.prototype.removeTrackIfContains=function(t,e){var r=e.findIndex((function(e){return e.id===t.id}));-1!==r&&e.splice(r,1)},t.prototype.queue0=function(t){this.queue=r.__assign(r.__assign({},this.state.queue),t)},t.prototype.notify=function(){var t=r.__assign({},this.state);this.subscribers.forEach((function(e){return e(t)}))},t}();function V(t){return t?t.duration:0}function S(t,e){return e[0]&&!function(t,e){for(var r=t.items,i=0;i<r.length;i++){var s=r[i];if(I(s,e[0])){for(var n=1;n<e.length;n++)if(!I(s=r[i+n],e[n]))return!1;return!0}}return!1}(t,e)?r.ChunkedList.of(e.concat(t.items),t.chunk,t.totalCount):t}function I(t,e){return t===e||t.id===e.id}function C(t,e){var i;return e?(i=x(t.items.filter((function(t){return e.id!==t.id})))).unshift(e):i=x(t.items),r.ChunkedList.of(i,t.chunk,t.totalCount)}function x(t){for(var e,r=t.slice(0),i=r.length-1;i>0;i--){var s=Math.floor(Math.random()*(i+1));e=[r[s],r[i]],r[i]=e[0],r[s]=e[1]}return r}var O="ERROR_EMPTY",L=function(){function t(t,e){this.store=t,this.fetcher=e}return t.prototype.restore=function(t,e,r){var i=this;return this.fetch({type:t,id:e}).catch((function(){return i.fetch({type:8})})).then((function(t){var e=i.chooseFirstTrack(t.tracks.items,r);i.store.updateQueue(e,t)}))},t.prototype.update=function(t){var e=this;return this.fetch(t).then((function(r){var i=t.track;t.preview&&(r.tracks=S(r.tracks,t.preview)),i?r.tracks=function(t,e){var r=t.items.findIndex((function(t){return e.id===t.id}));return-1===r?t.items.splice(0,0,e):e!==t.items[r]&&(t.items[r]=e),t}(r.tracks,i):i=e.chooseFirstTrack(r.tracks.items),e.store.updateQueue(i,r)}))},t.prototype.addPlaylist=function(t){var e=this;return this.fetch(t).then((function(r){e.store.addPlaylistToQueue(r.tracks.items.slice(),t)}))},t.prototype.loadMore=function(){var t=this,e=this.store.queue;return e.tracks.hasMore?(this.store.setQueueLoading(!0),this.fetcher.loadMore(e.type,e.id).then((function(e){t.mergeMoreTracksIntoQueue(e.clone())})).catch((function(){i.success("music.player.warn","load-more-"+e.type),t.store.queue=r.__assign(r.__assign({},e),{tracks:r.ChunkedList.of(e.tracks.items,{start:e.tracks.chunk.start,count:e.tracks.chunk.count,more:!1})})}))):Promise.reject("no-more-tracks")},t.prototype.toggleShuffle=function(){var t=this.store,e=t.track,r=t.queue,i=r.type,s=r.id,n=r.originalTracks;this.store.queue=n?{type:i,id:s,tracks:n}:{id:s,type:i,tracks:C(r.tracks,e),originalTracks:r.tracks}},t.prototype.mergeMoreTracksIntoQueue=function(t){var e=this,i=this.store.queue,s=i.tracks,n=i.originalTracks,a=s.items,o=t.items.slice(t.chunk.start);a.forEach((function(t){return e.store.removeTrackIfContains(t,o)})),n&&(i.originalTracks=n.add(o,t.chunk,t.totalCount)),this.store.queue=r.__assign(r.__assign({},i),{tracks:s.add(o,t.chunk,t.totalCount)})},t.prototype.chooseFirstTrack=function(t,e){if(e){var i=t.find((function(t){return t.id===e}));if(i&&!i.playRestricted)return i}var s=r.getIndexOfNextOrPrevUnrestricted(t,1,-1);if(-1===s)throw Promise.reject(O);return t[s]},t.prototype.fetch=function(t){var e=this;return 8===t.type&&"2"===String(t.id)&&(t.id=void 0),31!==t.type&&18!==t.type||(t.type=14),t.tracks?Promise.resolve({type:A(t.type),id:t.id,tracks:Array.isArray(t.tracks)?r.ChunkedList.of(t.tracks.slice()):t.tracks.clone()}):27===t.type&&t.track?Promise.resolve({type:27,id:t.id,tracks:r.ChunkedList.of([t.track])}):t.type?this.fetchTracks(A(t.type),t.id,t.ctx).catch((function(t){return i.success("music.player.warn",t,"queue-fetch"),e.fetchTracks(8)})).then((function(r){return t.tids?e.fetchTracks(-27,t.tids,t.ctx).then((function(e){var i=e.tracks;return t.preview=i.items,r})):r})):!t.tids||t.track&&t.tids===String(t.track.id)?t.track?Promise.resolve({type:0,tracks:r.ChunkedList.of([t.track])}):Promise.reject(O):this.fetchTracks(-27,t.tids,t.ctx).then((function(t){return{type:0,tracks:t.tracks}}))},t.prototype.fetchTracks=function(t,e,r){return this.fetcher.fetchTracks(t,e,r).then((function(r){return{type:t,id:e,tracks:r.clone()}}))},t}();function q(t){return"source"in t}function E(t,e,r,s,n){if(navigator.mediaSession){navigator.mediaSession.metadata=function(t){if(q(t))return new MediaMetadata({title:t.name,artwork:[{src:t.logoColored,type:"image/svg",sizes:"90x90"}]});return new MediaMetadata({title:t.name,artist:t.artists.map((function(t){return t.name})).join(", "),album:t.album.name,artwork:t.cover?[{src:"".concat(t.cover,"&fn=music.w_96"),sizes:"96x96",type:"image/png"},{src:"".concat(t.cover,"&fn=music.w_128"),sizes:"128x128",type:"image/png"},{src:t.cover,sizes:"192x192",type:"image/png"}]:void 0})}(e),navigator.mediaSession.setActionHandler("play",(function(){i.success("music.player","media-session","play"),t.resume()})),navigator.mediaSession.setActionHandler("pause",(function(){i.success("music.player","media-session","pause"),t.pause()})),navigator.mediaSession.setActionHandler("previoustrack",(function(){i.success("music.player","media-session","previoustrack"),s()})),navigator.mediaSession.setActionHandler("nexttrack",(function(){i.success("music.player","media-session","nexttrack"),r()})),n?navigator.mediaSession.setActionHandler("seekto",(function(t){var e=t.seekTime;i.success("music.player","media-session","seekto"),n(e)})):navigator.mediaSession.setActionHandler("seekto",null);var a=q(e);navigator.mediaSession.setActionHandler("seekbackward",a?null:function(){i.success("music.player","media-session","seekbackward"),t.seek(t.currentTime-10)}),navigator.mediaSession.setActionHandler("seekforward",a?null:function(){i.success("music.player","media-session","seekforward"),t.seek(t.currentTime+10)})}}var R,j,U,M=function(){function t(t){var e=this;this.store=t,window.addEventListener("unload",(function(){return e.log("APP_CLOSE")}))}return Object.defineProperty(t.prototype,"playStartTime",{get:function(){return this.playStartAt},set:function(t){this.playStartAt=t,clearTimeout(this.heartbeatTimer),void 0!==t&&this.startHeartbeatTimer()},enumerable:!1,configurable:!0}),t.prototype.startHeartbeatTimer=function(){var t=this;this.heartbeatTimer=setTimeout((function(){t.log("HEARTBEAT"),t.playStartAt=t.initPlayStartAt(),t.startHeartbeatTimer()}),3e4)},t}(),N=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r.__extends(e,t),e.prototype.log=function(t,e){void 0===e&&(e=!0),this.store.radioStation||(this.logByLogger(t,1e3*this.playStartTime,1e3*this.store.currentTime),e&&(this.playStartTime=void 0))},e.prototype.initPlayStartAt=function(){return this.store.currentTime},e.prototype.logByLogger=function(t,e,r){var s=this.store.track;if(s){var n={trackid:s.id,ctx:s.ctx,trigger:t,startTime:e,endTime:r};i.success("music.play","ok.mobile.app.music.timespent",JSON.stringify(n))}},e}(M),D=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r.__extends(e,t),e.prototype.log=function(t){"PLAY"===t&&(this.playStartTime=Date.now()),this.logByLogger(t),"PLAY"!==t&&(this.playStartTime=void 0)},e.prototype.initPlayStartAt=function(){return Date.now()},e.prototype.logByLogger=function(t){var e=this.store.radioStation;if(e){var r={fmId:e.id,regionId:e.regionId,duration:Date.now()-this.playStartTime,trigger:t};i.success("music.fmPlay","ok.mobile.app.radio.timespent",JSON.stringify(r))}},e}(M),H="externalMusic",F=(R=window.navigator.userAgent,j=window.navigator.platform,-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(j)?"Mac OS":-1!==["iPhone","iPad","iPod"].indexOf(j)?"iOS":-1!==["Win32","Win64","Windows","WinCE"].indexOf(j)?"Windows":/Android/.test(R)?"Android":/Linux/.test(j)?"Linux":void 0),Q=!1;function B(t,e,s){e&&s&&(i.success(H,"listened",JSON.stringify(r.__assign(r.__assign({},s),{trackId:e.id,ctx:e.ctx,releaseId:e.releaseId,endReason:t,repeat:"off"===s.repeat?void 0:"one"===s.repeat?1:2,useDuration:Math.round((Date.now()-s.startTimestamp)/1e3),stateStart:s.stateStart?2:1,stateEnd:document.hasFocus()?2:1,addedDuringListening:Q,previousUmaPayload:U,osType:F}))),U=s.umaPayload,Q=!1)}var J=function(){function t(t){var e,r=t.userId,s=t.state,n=t.api,a=t.queueFetcher,o=t.logRadioPlay,u=t.radioSupplier,c=t.isAdEnabled,l=t.chooseNextPlaylist,d=void 0===l?function(){return Promise.reject()}:l,p=this;this.userId=r,this.store=new P(s),this.api=n,this.queue=new L(this.store,a),this.timespentLogger=new N(this.store),this.timespentRadioLogger=new D(this.store),this.logRadioPlay=o,this.radioSupplier=u,this.isAdEnabled=c,this.audio=(e=new Audio(T),new _(e,T)).on(1,(function(){var t;p.store.playing=!0,p.state.radioStation?p.timespentRadioLogger.log("PLAY"):p.timespentLogger.playStartTime||(p.timespentLogger.playStartTime=p.store.currentTime),p.timespentLogger.log("PLAY",!1),null===(t=p.tabsChannel)||void 0===t||t.postMessage(null)})).on(2,(function(){p.store.playing=!1,p.state.radioStation&&p.timespentRadioLogger.log("PAUSE")})).on(3,(function(t){return p.store.loading=t})).on(7,(function(t){p.store.startAd(t),p.stopPlay30Timer()})).on(8,(function(){p.store.ad=!1;var t=p.state.track;t&&p.startPlay30Timer(null==t?void 0:t.id,null==t?void 0:t.ctx)})).on(9,(function(t){return p.store.updateAdTime(t)})).on(5,(function(t){return p.store.updateTime(t)})).on(4,(function(t){var e=t.cached;return p.store.cached=e})).on(6,(function(){var t=p.state,e=t.ad,r=t.repeat,i=t.track,s=t.queue;if(!e){if(B(4,i,p.logData),p.timespentLogger.log("END_TRACK"),"off"!==r||s.tracks.items.indexOf(i)+1!==s.tracks.items.length)return"one"===r?(p.seek(0),void p.startPlay30Timer(i.id,i.ctx)):void p.playQueueItem(1).catch((function(){return p.rewind()}));d(p.store.queue.type,p.store.queue.id).then((function(t){var e=t.type,r=t.id;return p.playQueue0(e,r)})).catch((function(){return p.rewind()}))}})).on(0,(function(t){i.success("music.player.error","audio",t.code),B(4,p.state.track,p.logData),p.store.playing=!1,p.store.loading=!1})).on(10,(function(t){var e=t.to;void 0!==p.timespentLogger.playStartTime&&p.timespentLogger.log("REWIND_TIME"),p.timespentLogger.playStartTime=e})),window.BroadcastChannel&&(this.tabsChannel=new BroadcastChannel("music_player_tabs"),this.tabsChannel.onmessage=this.pause.bind(this)),this.audio.volume=this.state.volume}return Object.defineProperty(t.prototype,"state",{get:function(){return this.store},enumerable:!1,configurable:!0}),t.prototype.subscribe=function(t){return this.store.subscribe(t)},t.prototype.restore=function(t,e,r){return this.store.track?Promise.resolve():(26===t&&"0"===e?(t=55,e=String(r)):55===t&&(t=8,e=void 0),this.queue.restore(t,e))},t.prototype.playRadio=function(t){var e=this,r=t.id,s=t.regionId,n=t.source,a=t.name;return this.store.radioStation&&this.store.radioStation.id===r&&this.store.radioStation.regionId===s?this.state.playing?(this.pause(),Promise.resolve()):(i.success("music.radio-fm","play",a),this.audio.resume()):(this.audio.play(n),this.store.playRadio(t),this.state.radioStation&&this.state.playing&&this.timespentRadioLogger.log("SKIP_RADIO"),E(this.audio,t,(function(){return e.next()}),(function(){return e.prev()})),this.logRadioPlay(r,s),i.success("music.radio-fm","play",a),Promise.resolve())},t.prototype.play=function(t,e){var s,n=this;if(!t){var a=this.state.track;return a&&a.playRestricted?this.playQueueItem(1,0):(this.state.radioStation&&i.success("music.radio-fm","play",this.state.radioStation.name),this.resume())}var o=e?Array.isArray(e)?{tracks:e}:e:{};return B(3,this.state.track,this.logData),this.store.radioStation||(null===(s=this.store.track)||void 0===s?void 0:s.id)===t||this.timespentLogger.log("SKIP_TRACK"),this.playTrack(t,o.ctx).then((function(t){var e=o.type,i=o.ctx;return!e&&i&&0===i.indexOf("messaging")&&(o.type=27,o.id=t.id),n.queue.update(r.__assign(r.__assign({},o),{track:t,id:o.id?String(o.id):void 0}))}))},t.prototype.playQueue=function(t,e,r){var i=e?String(e):void 0,s=this.state.queue;return t!==s.type||i!==s.id||this.state.playing?this.playQueue0(t,i,r):this.resume()},t.prototype.addPlaylistToQueue=function(t,e,r){var i=e?String(e):void 0;return this.queue.addPlaylist({type:t,id:i,ctx:r})},t.prototype.pause=function(){this.state.radioStation?i.success("music.radio-fm","pause",this.state.radioStation.name):this.timespentLogger.log("PAUSE"),this.audio.pause()},t.prototype.setVolume=function(t){this.audio.volume=t,this.store.volume=t},t.prototype.toggleLyricsState=function(t){this.store.lyricsIsOpen=!this.state.ad&&(null!=t?t:!this.state.lyricsIsOpen)},t.prototype.hideLyrics=function(){this.store.lyricsIsOpen=!1},t.prototype.setVolumeRelative=function(t){var e=this.state.volume,r=1===t?Math.min(e+10,100):Math.max(e-10,0);this.audio.volume=r,this.store.volume=r},t.prototype.toggleMute=function(){this.state.muted?this.setVolume(this.state.volume||50):(this.audio.volume=0,this.store.muted=!0)},t.prototype.tempPrev=function(t){this.prev(t)},t.prototype.tempNext=function(){this.next()},t.prototype.prev=function(t){return void 0===t&&(t=!1),this.disablePlayerActions()?Promise.resolve():this.state.radioStation||t||this.state.currentTime<=10?(B(2,this.state.track,this.logData),this.playQueueItem(-1)):(this.seek(0),Promise.resolve())},t.prototype.next=function(t){return this.disablePlayerActions()?Promise.resolve():(B(1,this.state.track,this.logData),this.store.radioStation||this.timespentLogger.log("SKIP_TRACK"),this.state.radioStation||t||"one"!==this.state.repeat?this.playQueueItem(1):(this.seek(0),Promise.resolve()))},t.prototype.seek=function(t){this.disablePlayerActions()||this.state.radioStation||(this.resume(),this.audio.seek(t),this.store.updateTime({currentTime:t}))},t.prototype.seekRelative=function(t){if(!this.disablePlayerActions()&&!this.state.radioStation){var e=this.store.currentTime+10*t;e<0&&(e=0),this.audio.seek(e),this.store.updateTime({currentTime:e})}},t.prototype.toggleShuffle=function(){this.queue.toggleShuffle()},t.prototype.toggleRepeat=function(){this.store.toggleRepeat()},t.prototype.loadMoreTracks=function(){return this.state.queue.tracks.hasMore?this.queue.loadMore():Promise.resolve()},t.prototype.addTrack=function(t){this.store.addTrack(t)},t.prototype.removeTrack=function(t){this.state.track===t&&this.store.playing&&this.next(!0),this.store.removeTrack(t)},t.prototype.reorderTrack=function(t,e){this.store.reorderTrack(t,e)},t.prototype.disablePlayerActions=function(){return this.state.ad},t.prototype.resume=function(){var t=this;if(this.isActualSrc())return this.audio.resume();var e=this.state,r=e.track,i=e.queue;return r?this.playTrack(r).then((function(){return t.store.updateQueue(r,i)})):Promise.reject("no-track")},t.prototype.isActualSrc=function(){var t=this.audio.currentSrc;return this.state.ad||this.state.radioStation||t&&t===this.state.currentTrackSrc},t.prototype.playTrack=function(t,e){var s,n=this;return t?("object"!=typeof t?(s=Number(t),this.logData=void 0,this.store.loading=!0):(s=Number(t.id),e=e||t.ctx,this.logData=void 0,this.store.track=t),e||i.clob("music.player.warn",Error("[play] ctx is empty, track: "+JSON.stringify(t)).stack,"empty-ctx"),"friend_portlet"===e&&(i.success("music.player","ctx-fix","friend_portlet"),e="friend"),this.api.post("play",{tid:s,ctx:e}).then((function(e){var i=n.state.track;if("object"!=typeof t)t=r.convertTrack(e.track,e.albums[0]);else if(i&&i.id!==t.id)throw new Error("track-changed");var s=r.signURL(e.play),a=n.isAdEnabled?function(t,e,r){if(r.commercial&&t)return{userId:t,categoryId:g(e),trackId:r.track.id,duration:r.track.duration,genre:r.commercialGenre||19,userType:r.commercialUserType||3}}(n.userId,n.state.queue.type,e):void 0;return n.audio.play(s,a),n.store.play(t,e.friend,e.trackRadio,s),n.logData={umaPayload:e.umaPayload,startTimestamp:Date.now(),repeat:n.state.repeat,shuffle:!!n.state.queue.originalTracks,stateStart:document.hasFocus()},E(n.audio,t,(function(){return n.next()}),(function(){return n.prev()}),(function(t){return n.seek(t)})),n.startPlay30Timer(t.id,t.ctx),t}))):(i.clob("music.player.warn",Error("[play] tid is empty, track: "+JSON.stringify(t)).stack,"no-track"),Promise.reject())},t.prototype.playQueue0=function(t,e,r){var i=this;return this.queue.update({type:t,id:e,ctx:r}).then((function(){i.state.radioStation=void 0,i.playQueueItem(1,-1)}))},t.prototype.playQueueItem=function(t,e,s){var n=this;void 0===s&&(s=0);var a=this.state.radioStation;if(a){var o=this.radioSupplier();return e=r.getIndexOfNextOrPrevStation(a,o,t),this.playRadio(o[e])}var u=this.state.queue.tracks,c=u.items,l=u.hasMore,d=c.length,p=this.state.repeat;if(e=void 0===e?this.store.getCurrentIndex():e,e=r.getIndexOfNextOrPrevTrack(e,u,p,t),s>3||-1===e)return Promise.reject();this.needToLoadMore(u,e,s)&&this.loadMoreTracks(),e>=d?e=0:e<0&&(e=l?0:d-1);var h=c[e];return this.playTrack(h).catch((function(r){if(i.success("music.player.error","play-track",r.message||r),"error.copyright.restriction"===r.message||"error.play.track.unplayable"===r.message)return n.playQueueItem(t,e,s+1);throw r}))},t.prototype.needToLoadMore=function(t,e,r){var i=t.hasMore,s=t.loading,n=t.items,a=n.length;return i&&!s&&(a-e<10||!this.areEnoughUnrestrictedTracks(n,e))&&0===r},t.prototype.areEnoughUnrestrictedTracks=function(t,e,r){void 0===r&&(r=3);for(var i=0,s=e;s<t.length;s++)t[s].playRestricted||i++;return r<=i},t.prototype.startPlay30Timer=function(t,e){var r=this;this.stopPlay30Timer(),this.play30Timer=setTimeout((function(){return r.play30(t,e)}),3e4)},t.prototype.stopPlay30Timer=function(){this.play30Timer&&clearTimeout(this.play30Timer)},t.prototype.play30=function(t,e){this.api.post("play30",{tid:t,ctx:e,skipUmaLog:!0})},t.prototype.rewind=function(){this.audio.pause(),this.store.rewind()},t}();var K=function(t){var e,r=t.Symbol;return"function"==typeof r?r.observable?e=r.observable:(e=r("observable"),r.observable=e):e="@@observable",e}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),W=function(){return Math.random().toString(36).substring(7).split("").join(".")},X={INIT:"@@redux/INIT"+W(),REPLACE:"@@redux/REPLACE"+W(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+W()}};function Y(t,e,r){var i;if("function"==typeof e&&"function"==typeof r||"function"==typeof r&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function.");if("function"==typeof e&&void 0===r&&(r=e,e=void 0),void 0!==r){if("function"!=typeof r)throw new Error("Expected the enhancer to be a function.");return r(Y)(t,e)}if("function"!=typeof t)throw new Error("Expected the reducer to be a function.");var s=t,n=e,a=[],o=a,u=!1;function c(){o===a&&(o=a.slice())}function l(){if(u)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return n}function d(t){if("function"!=typeof t)throw new Error("Expected the listener to be a function.");if(u)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribelistener for more details.");var e=!0;return c(),o.push(t),function(){if(e){if(u)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribelistener for more details.");e=!1,c();var r=o.indexOf(t);o.splice(r,1),a=null}}}function p(t){if(!function(t){if("object"!=typeof t||null===t)return!1;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}(t))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===t.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(u)throw new Error("Reducers may not dispatch actions.");try{u=!0,n=s(n,t)}finally{u=!1}for(var e=a=o,r=0;r<e.length;r++){(0,e[r])()}return t}return p({type:X.INIT}),(i={dispatch:p,subscribe:d,getState:l,replaceReducer:function(t){if("function"!=typeof t)throw new Error("Expected the nextReducer to be a function.");s=t,p({type:X.REPLACE})}})[K]=function(){var t,e=d;return(t={subscribe:function(t){if("object"!=typeof t||null===t)throw new TypeError("Expected the observer to be an object.");function r(){t.next&&t.next(l())}return r(),{unsubscribe:e(r)}}})[K]=function(){return this},t},i}function z(t,e){var r=e&&e.type;return"Given "+(r&&'action "'+String(r)+'"'||"an action")+', reducer "'+t+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function G(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function Z(t,e){var r=Object.keys(t);return Object.getOwnPropertySymbols&&r.push.apply(r,Object.getOwnPropertySymbols(t)),e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r}function $(){for(var t=arguments,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=t[i];return 0===r.length?function(t){return t}:1===r.length?r[0]:r.reduce((function(t,e){return function(){return t(e.apply(void 0,arguments))}}))}function tt(){for(var t=arguments,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=t[i];return function(t){return function(){var e=t.apply(void 0,arguments),i=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},s={getState:e.getState,dispatch:function(){return i.apply(void 0,arguments)}},n=r.map((function(t){return t(s)}));return function(t){for(var e=arguments,r=1;r<arguments.length;r++){var i=null!=e[r]?e[r]:{};r%2?Z(i,!0).forEach((function(e){G(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Z(i).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},e,{dispatch:i=$.apply(void 0,n)(e.dispatch)})}}}function et(t,e){if(e){var i=r.__assign({},t);return e.forEach((function(t){var e,s=i[t.id],n=(null===(e=null==s?void 0:s.playlist)||void 0===e?void 0:e.importing)&&!t.importing;i[t.id]=r.__assign(r.__assign({},s),{playlist:r.__assign(r.__assign(r.__assign({},null==s?void 0:s.playlist),t),{importing:t.importing}),tracks:n?r.ChunkedList.empty():s&&s.tracks||r.ChunkedList.empty(t.count),favourite:!0})})),i}return t}function rt(t,e){switch(e.type){case"tracks/set_tracks_loading":return function(t,e){return r.__assign(r.__assign({},t),{tracks:(t.tracks||r.ChunkedList.empty()).setLoading(e)})}(t,e.loading);case"tracks/set_tracks":return function(t,e){var i,s,n,a,o,u,c,l,d,p=t.tracks||r.ChunkedList.empty(),h=e.tracks?p.add(r.convertTracks(e.tracks,e.albums),e.chunk,e.totalTracks):p;return r.__assign(r.__assign({},t),{playlist:{id:e.id||(null===(i=t.playlist)||void 0===i?void 0:i.id),name:e.name||(null===(s=t.playlist)||void 0===s?void 0:s.name),playCount:e.playCount||(null===(n=t.playlist)||void 0===n?void 0:n.playCount),subscribers:e.subscribers||(null===(a=t.playlist)||void 0===a?void 0:a.subscribers),images:e.images||(null===(o=t.playlist)||void 0===o?void 0:o.images),editable:e.editable||(null===(u=t.playlist)||void 0===u?void 0:u.editable),importing:e.importing||(null===(c=t.playlist)||void 0===c?void 0:c.importing),newTracksCount:e.newTracksCount||(null===(l=t.playlist)||void 0===l?void 0:l.newTracksCount),playlistId:e.playlistId||(null===(d=t.playlist)||void 0===d?void 0:d.playlistId)},chunkedPlaylists:e.playlistsChunk&&e.playlists?(t.chunkedPlaylists||r.ChunkedList.empty()).add(e.playlists,e.playlistsChunk,e.totalPlaylists):t.chunkedPlaylists,tracks:h,similarTracks:e.extension?r.ChunkedList.of(r.convertTracks(e.extension,e.albums),{more:!0}):t.similarTracks,owner:e.owner||t.owner,groupOwner:e.groupOwner||t.groupOwner,favourite:e.favourite||t.favourite,playlists:e.playlists&&!e.playlistsChunk?e.playlists:t.playlists,subscribed:e.subscribed||t.subscribed})}(t,e.data);case"tracks/add_similar_tracks":return function(t,e){if(!e.tracks)return t;if(t.similarTracks){var i=function(t,e){return t.filter((function(t){return!e.has(t.id)&&(e.add(t.id),!0)}))}(r.convertTracks(e.tracks,e.albums),function(t){return new Set(t.map((function(t){return t.id})))}(t.similarTracks.items));return r.__assign(r.__assign({},t),{similarTracks:nt(t.similarTracks.items.concat(i),i.length>0)})}return r.__assign(r.__assign({},t),{similarTracks:nt(r.convertTracks(e.tracks,e.albums),!0)})}(t,e.data);case"tracks/add_tracks":return function(t,e,i,s){void 0===e&&(e=[]);var n=!1;if(st(t.tracks)){var a=new Set(e.map((function(t){return t.id}))),o=t.tracks.items.filter((function(t){return!a.has(t.id)})),u=t.tracks.totalCount;e=e.map((function(t){return r.__assign({},t)})),t.tracks=r.ChunkedList.of(e.concat(o),t.tracks.chunk,s||u),n=!0}i&&(t.playlist=r.__assign(r.__assign({},t.playlist),{images:i||t.playlist.images}),n=!0);return n?r.__assign({},t):t}(t,e.tracks,e.images,e.totalTracks);case"tracks/remove_track":return function(t,e){if(t.tracks){var i=t.tracks.items.findIndex((function(t){return t.id===e}));if(i>-1){var s=t.tracks.items.slice(),n=t.tracks.totalCount;return s.splice(i,1),r.__assign(r.__assign({},t),{tracks:r.ChunkedList.of(s,t.tracks.chunk,n?n-1:n)})}}return t}(t,e.tid);case"tracks/replace_track":return function(t,e,i){var s=t.tracks.items,n=s.findIndex((function(t){return t.id===e}));if(n>-1)return s[n]=i,r.__assign(r.__assign({},t),{tracks:t.tracks.setItems(r.__spreadArray([],s,!0))});return t}(t,e.tid,e.track);case"tracks/mark_track_as_removed":return function(t,e){var i=t.tracks.totalCount;return r.__assign(r.__assign({},t),{removed:it(t.removed,e),tracks:t.tracks.setTotalCount(i?i-1:i)})}(t,e.tid);case"tracks/remove_marked_tracks":return function(t){if(t.removed&&t.tracks)return r.__assign(r.__assign({},t),{tracks:t.tracks.setItems(t.tracks.items.filter((function(e){return!t.removed.has(e.id)}))),removed:void 0});return t}(t);case"tracks/reorder_tracks":return function(t,e,i){if(t.tracks){var s=t.tracks.items.slice(),n=s.splice(e,1)[0];return s.splice(i,0,n),r.__assign(r.__assign({},t),{tracks:t.tracks.setItems(s)})}return t}(t,e.from,e.to);case"tracks/restore_track":return function(t,e){if(t.removed&&t.removed.delete(e)){var i=t.tracks.totalCount;return r.__assign(r.__assign({},t),{tracks:t.tracks.setTotalCount(i?i+1:i),removed:new Set(Array.from(t.removed))})}return t}(t,e.tid);case"tracks/add_uploaded_tracks":return function(t,e){void 0===e&&(e=[]);if(st(t.tracks)){var i=new Set(e.map((function(t){return t.id}))),s=t.tracks.items.filter((function(t){return!i.has(t.id)}));return r.__assign(r.__assign({},t),{tracks:r.ChunkedList.of(e.concat(s),t.tracks.chunk,(t.tracks.totalCount||0)+e.length)})}return t}(t,e.tracks);case"tracks/create_playlist":case"tracks/update_all_playlists":return function(t,e){void 0===e&&(e=[]);var i=t.chunkedPlaylists,s=i?i.items:t.playlists||[];e.forEach((function(t){var e=s.findIndex((function(e){return e.id===t.id}));-1!==e?s[e]=r.__assign(r.__assign(r.__assign({},s[e]),t),{importing:t.importing}):s.unshift(r.__assign({},t))}));var n=r.__assign({},t);i?n.chunkedPlaylists=i.clone():n.playlists=s;return n}(t,e.playlists);case"tracks/update_playlist":return function(t,e,i){var s=t.chunkedPlaylists,n=s?s.items:t.playlists||[],a=n.map((function(t){return t.id===e?r.__assign(r.__assign({},t),i):t})),o=r.__assign({},t);s?o.chunkedPlaylists=s.setItems(a):o.playlists=a;return o}(t,e.pid,e.playlist);case"tracks/un_favor_playlist":return function(t,e){var i=t.chunkedPlaylists,s=((null==i?void 0:i.items)||[]).map((function(t){return t.id===e?r.__assign(r.__assign({},t),{favourite:!1}):t}));return r.__assign(r.__assign({},t),{chunkedPlaylists:null==i?void 0:i.setItems(s)})}(t,e.pid)}return t}function it(t,e){if(!t)return new Set([e]);var r=Array.from(t);return r.push(e),new Set(r)}function st(t){return t.isNotEmpty||!t.hasMore}function nt(t,e){return r.ChunkedList.of(t,{more:e})}var at=new Map;function ot(t,e,i){var s=t.get(e);return s?(t.set(e,r.__assign(r.__assign({},s),i)),new Map(t)):t}function ut(t,e,i,s){var n;void 0===s&&(s=!1);var a=r.__spreadArray([],null!==(n=t.radios)&&void 0!==n?n:[],!0),o=a.findIndex((function(t){return t.id===e&&t.regionId===i}));return a[o]=r.__assign(r.__assign({},a[o]),{favourite:s}),r.__assign(r.__assign({},t),{radios:a})}var ct,lt={tracks:r.ChunkedList.empty()},dt=function(t){for(var e=Object.keys(t),r={},i=0;i<e.length;i++){var s=e[i];"function"==typeof t[s]&&(r[s]=t[s])}var n,a=Object.keys(r);try{!function(t){Object.keys(t).forEach((function(e){var r=t[e];if(void 0===r(void 0,{type:X.INIT}))throw new Error('Reducer "'+e+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===r(void 0,{type:X.PROBE_UNKNOWN_ACTION()}))throw new Error('Reducer "'+e+"\" returned undefined when probed with a random type. Don't try to handle "+X.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')}))}(r)}catch(t){n=t}return function(t,e){if(void 0===t&&(t={}),n)throw n;for(var i=!1,s={},o=0;o<a.length;o++){var u=a[o],c=r[u],l=t[u],d=c(l,e);if(void 0===d){var p=z(u,e);throw new Error(p)}s[u]=d,i=i||d!==l}return(i=i||a.length!==Object.keys(t).length)?s:t}}({currentUser:function(t,e){switch(void 0===t&&(t={id:"0"}),e.type){case"app/init":return i=String(e.userId),s=e.subscribed,n=e.isRU,{id:i,subscribed:s,isRU:n};case"current_user/update_subscription_status":return function(t,e){return r.__assign(r.__assign({},t),{subscribed:e})}(t,e.subscribed);default:return t}var i,s,n},radio:function(t,e){switch(void 0===t&&(t={}),e.type){case"radio/set":return function(t,e,i){return r.__assign(r.__assign({},t),{radios:e,marker:i})}(t,e.radios,e.marker);case"radio/add":return function(t,e,i){var s=t.radios||[];return r.__assign(r.__assign({},t),{radios:r.__spreadArray(r.__spreadArray([],s,!0),e,!0),marker:i})}(t,e.radios,e.marker);case"radio/like":return ut(t,e.fmId,e.regionId,!0);case"radio/dislike":return ut(t,e.fmId,e.regionId);default:return t}},playlists:ht((function(t,e){switch(e.type){case"tracks/update_all_playlists":return et(t,e.playlists);case"tracks/create_playlist":return function(t,e,i,s,n){var a=et(t,i);a[e]&&(a[e].editable=!0,a[e].playlist=r.__assign(r.__assign({},a[e].playlist),{editable:!0}),a[e].tracks=r.ChunkedList.of(s,{start:0,count:s.length,more:!1}),a[e].groupOwner=n);return a}(t,e.newPlaylistId,e.playlists,e.tracks,e.groupOwner);case"tracks/update_playlist":case"playlists/update":return function(t,e,i){var s;if(t[e])return r.__assign(r.__assign({},t),((s={})[e]=r.__assign(r.__assign({},t[e]),{playlist:r.__assign(r.__assign({},t[e].playlist),i)}),s));return t}(t,e.pid,e.playlist);case"tracks/un_favor_playlist":return function(t,e){var i;if(t[e])return r.__assign(r.__assign({},t),((i={})[e]=r.__assign(r.__assign({},t[e]),{favourite:!1}),i));return t}(t,e.pid)}return t}),pt("playlists")),users:ht((function(t,e){switch(e.type){case"app/init":return function(t,e,i,s,n,a){var o,u=t[e]||{},c=r.createDataTable(i),l=null==s?void 0:s.map((function(t){return c[t]}));return r.__assign(r.__assign({},t),(o={},o[e]={tracks:u.tracks?u.tracks.setTotalCount(n):r.ChunkedList.empty(n),chunkedPlaylists:r.ChunkedList.of(l,a)},o))}(t,e.userId,e.playlists,e.myPlaylists,e.totalTracks,e.playlistsChunk);case"users/set-loading-to-user-playlists":return function(t,e){var i,s,n=t[e]||{chunkedPlaylists:r.ChunkedList.empty()};return r.__assign(r.__assign({},t),(i={},i[e]=r.__assign(r.__assign({},n),{chunkedPlaylists:null===(s=n.chunkedPlaylists)||void 0===s?void 0:s.setLoading(!0)}),i))}(t,e.userId);case"users/add-user-playlists":return function(t,e,i,s,n){var a,o,u,c=t[e]||{chunkedPlaylists:r.ChunkedList.empty()};if(s){var l=r.createDataTable(i);u=s.map((function(t){return l[t]}))}return r.__assign(r.__assign({},t),(a={},a[e]=r.__assign(r.__assign({},c),{chunkedPlaylists:null===(o=c.chunkedPlaylists)||void 0===o?void 0:o.add(u||i,n)}),a))}(t,e.userId,e.playlists,e.myPlaylists,e.playlistsChunk);case"tracks/un_favor_playlist":return function(t,e,i){var s,n,a,o=t[e]||{chunkedPlaylists:r.ChunkedList.empty()},u=(null===(n=null==o?void 0:o.chunkedPlaylists)||void 0===n?void 0:n.items.filter((function(t){return t.id!==i})))||[];return r.__assign(r.__assign({},t),(s={},s[e]=r.__assign(r.__assign({},o),{chunkedPlaylists:null===(a=o.chunkedPlaylists)||void 0===a?void 0:a.setItems(u)}),s))}(t,e.id,e.pid);case"users/move-user-playlist":return function(t,e,i,s){var n,a,o,u=t[e],c=(null===(a=null==u?void 0:u.chunkedPlaylists)||void 0===a?void 0:a.items)||[],l=c.findIndex((function(t){return t.id===i})),d=c.splice(l,1)[0];return c.splice(s,0,d),r.__assign(r.__assign({},t),(n={},n[e]=r.__assign(r.__assign({},u),{chunkedPlaylists:null===(o=u.chunkedPlaylists)||void 0===o?void 0:o.setItems(c.slice())}),n))}(t,e.userId,e.pid,e.position);default:return t}}),pt("users")),groups:pt("groups"),collections:pt("collections"),player:function(t,e){return void 0===t&&(t=w),"app/restore"===e.type?r.__assign(r.__assign({},t),e.player):"player/update"===e.type?e.state:t},uploads:function(t,e){switch(void 0===t&&(t=at),e.type){case"upload/setUploads":return e.uploads.forEach((function(e){return t.set(e.cid,e)})),new Map(t);case"upload/setUploadId":return ot(t,e.cid,{uploadId:e.uploadId});case"upload/setProgress":return ot(t,e.cid,{progress:e.progress});case"upload/setFinish":return ot(t,e.cid,{status:"uploaded"});case"upload/setError":return ot(t,e.cid,{status:"failed",error:e.error});case"upload/setReset":return ot(t,e.cid,{status:"uploading",error:void 0});case"upload/setRemove":return t.delete(e.cid)?new Map(t):t;default:return t}},configuration:function(t){return void 0===t&&(t={confJson:{}}),t},addedTracks:function(t,e){switch(void 0===t&&(t=[]),e.type){case"added_tracks/add":return function(t,e){if(Array.isArray(e)){var i=e.filter((function(e){return function(t,e){return!t.includes(e)}(t,e)}));return r.__spreadArray(r.__spreadArray([],t,!0),i,!0)}return r.__spreadArray(r.__spreadArray([],t,!0),[e],!1)}(t,e.tracks);case"added_tracks/remove":return function(t,e){return t.filter((function(t){return t!==e}))}(t,e.id)}return t},banners:function(t,e){switch(void 0===t&&(t={}),e.type){case"app/restore":return function(t,e){return r.__assign(r.__assign({},t),e)}(t,e.banners);case"banner/hide":return function(t,e){var i;return r.__assign(r.__assign({},t),(i={},i[e]=Date.now(),i))}(t,e.bannerId);default:return t}}});function pt(t){return function(e,i){var s;if(void 0===e&&(e={}),i.id&&i.branch===t){var n=e[i.id]||lt,a=rt(n,i);if(a!==n)return r.__assign(r.__assign({},e),((s={})[i.id]=a,s))}return e}}function ht(){for(var t=arguments,e=[],r=0;r<arguments.length;r++)e[r]=t[r];return function(t,r){void 0===t&&(t={});for(var i=0,s=e;i<s.length;i++){var n=(0,s[i])(t,r);if(n!==t)return n}return t}}function ft(){return function(t){return function(e){try{return t(e)}catch(t){throw i.clob("music.reducer.error",t.stack,e.type),t}}}}function yt(t){return{player:{volume:t.player.volume,repeat:t.player.repeat},banners:r.__assign({},t.banners)}}function mt(t){return"".concat(t,"_music-state")}function gt(t,e){if(t===e)return!0;if(!t||!e||"object"!=typeof t||"object"!=typeof e)return t!=t&&e!=e;if(t.constructor!==e.constructor)return!1;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();var r=Object.keys(t);return r.length===Object.keys(e).length&&(!!r.every(Object.prototype.hasOwnProperty.bind(e))&&r.every((function(r){return gt(t[r],e[r])})))}var kt=function(){function t(t){this.api=t}return t.prototype.fetch=function(t,e){return this.api.get("album",{albumId:t,ctx:e}).then((function(t){var e=t.album,i=t.tracks,s=t.albums;return{album:e,tracks:r.ChunkedList.of(r.convertTracksFromAlbum(i,e)),albums:s}}))},t.prototype.fetchTracks=function(t,e){return this.fetch(t,e).then((function(t){return t.tracks}))},r.__decorate([r.cacheable],t.prototype,"fetch",null),t}(),vt=function(){function t(t){this.api=t}return t.prototype.fetch=function(t,e){return this.api.get("artist",{artistId:t,count:100,sts:100,mvs:100,ctx:e}).then((function(t){var e=t.artist,i=t.tracks,s=t.albums,n=t.userAlbums,a=t.userAlbumsChunk,o=t.masterAlbums,u=t.masterAlbumsChunk,c=t.collaborations,l=t.collaborationsChunk,d=t.similarArtists,p=t.movies,h=t.similarTracks;return{artist:e,tracks:r.ChunkedList.of(r.convertTracks(i,s)),similarTracks:r.ChunkedList.of(r.convertTracks(h||[],s),{more:!0}),masterAlbums:o?r.ChunkedList.of(o,u):void 0,collaborations:c?r.ChunkedList.of(c,l):void 0,userAlbums:n?r.ChunkedList.of(n,a):void 0,similarArtists:d,videos:p}}))},t.prototype.loadMoreAlbums=function(t,e,i,s,n){return void 0===s&&(s=100),this.api.get("artistAlbums",{artistId:t,typeId:bt(i),start:e,count:s,ctx:n}).then((function(t){var e,s,n=t[i],a=t[(s=i,s+"Chunk")];return(e={})[i]=n?r.ChunkedList.of(n,a):void 0,e}))},t.prototype.fetchTracks=function(t,e){return this.fetch(t,e).then((function(t){return t.tracks}))},t.prototype.loadSimilarTracks=function(t){return Promise.all([this.fetch(t),this.api.get("similarTracksForArtist",{artistId:t,count:100})]).then((function(t){var e=t[0],i=t[1],s=function(t){var e=new Set;return t.similarTracks.items.forEach((function(t){return e.add(t.id)})),e}(e),n=r.convertTracks(i.tracks||[],i.albums).filter((function(t){return!s.has(t.id)})),a=e.similarTracks.items.concat(n);return e.similarTracks=r.ChunkedList.of(a,{more:n.length>0}),e.similarTracks}))},t.prototype.fetchSimilarTracks=function(t){return this.fetch(t).then((function(t){return t.similarTracks}))},r.__decorate([r.cacheable],t.prototype,"fetch",null),t}();function bt(t){switch(t){case"masterAlbums":return 1;case"userAlbums":return 2;case"collaborations":return 0}}var _t={tracks:r.ChunkedList.empty(),similarTracks:r.ChunkedList.empty()},Tt=function(){function t(t,e,r){this.branch=t,this.store=e,this.api=r}return t.prototype.getTracks=function(t){return this.get(t).tracks||r.ChunkedList.empty()},t.prototype.fetchTracks=function(t,e){var r=this.getTracks(t);return r.isNotEmpty||!r.hasMore?Promise.resolve(r):this.loadTracks(t,e)},t.prototype.loadTracks=function(t,e){var r=this;this.dispatch(t,"tracks/set_tracks_loading",{loading:!0});var i=this.getTracks(t),s=i.from;return this.request(t,s>0?i.items[0].ctx:e,s).then((function(e){return r.dispatch(t,"tracks/set_tracks",{data:e}),r.getTracks(t)})).catch((function(e){throw r.dispatch(t,"tracks/set_tracks_loading",{loading:!1}),e}))},t.prototype.getPlaylists=function(t){return this.get(t).chunkedPlaylists},t.prototype.getSimilarTracks=function(t){return this.get(t).similarTracks},t.prototype.fetchSimilarTracks=function(t){var e=this.get(t).similarTracks||r.ChunkedList.empty();return e.isNotEmpty||!e.hasMore?Promise.resolve(e):this.loadSimilarTracks(t)},t.prototype.loadSimilarTracks=function(t){var e=this;return this.requestSimilarTracks(t).then((function(r){return e.dispatch(t,"tracks/add_similar_tracks",{data:r}),e.get(t).similarTracks}))},t.prototype.editTrack=function(t,e,i,s,n){var a=this;return this.api.post("edit",{tid:e,pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tit:i,art:s,alb:n}).then((function(i){var s=i.edited,o=r.convertTrack(s,{id:s.albumId,name:n});return a.dispatch(t,"tracks/replace_track",{tid:e,track:o}),o}))},t.prototype.removeTrack=function(t,e){return this.dispatch(t,"tracks/remove_track",{tid:e}),this.api.post("dislike",{pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tid:e})},t.prototype.restoreTrack=function(t,e){var r=this.get(t).tracks.items.findIndex((function(t){return t.id===e}));return this.dispatch(t,"tracks/restore_track",{tid:e}),this.api.post("like",{pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tid:e,pos:r})},t.prototype.reorderTracks=function(t,e,r,i){var s=this.get(t),n=Math.min(s.tracks.totalCount,i);return this.dispatch(t,"tracks/reorder_tracks",{from:r,to:n}),this.api.post("reorder",{tid:e,pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,pos:n})},t.prototype.markTrackAsRemoved=function(t,e){return this.dispatch(t,"tracks/mark_track_as_removed",{tid:e}),this.api.post("dislike",{pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tid:e})},t.prototype.clearRemovedTracks=function(t){this.dispatch(t,"tracks/remove_marked_tracks")},t.prototype.requestSimilarTracks=function(t){return this.api.get("similarTracksForPlaylist",{pid:t,count:100})},t.prototype.createPlaylist=function(t,e,r){var i=this;return this.api.post("playlistsAdd",{name:e,tid:r.map((function(t){return t.id})).reverse().join(","),publicPlaylist:!0,groupId:"groups"===this.branch?t:void 0,excludeAllUserPlaylists:!0}).then((function(e){return i.dispatch(t,"tracks/create_playlist",{playlists:[e.playlist],newPlaylistId:e.newPlaylistId,groupOwner:"groups"===i.branch?i.get(t).groupOwner:void 0,tracks:r}),e}))},t.prototype.addPlaylist=function(t,e){return this.patchThenUpdatePlaylists(t,e,"playlistsAdd",{pid:e,excludeAllUserPlaylists:!0})},t.prototype.removePlaylist=function(t,e){var r=this;return this.patchPlaylists(t,e,"playlistsRemove",{excludeAllUserPlaylists:!0,pid:e}).then((function(i){return r.dispatch(t,"tracks/un_favor_playlist",{pid:e}),i}))},t.prototype.patchThenUpdatePlaylists=function(t,e,i,s){var n=this;return this.api.post(i,r.__assign({pid:e,groupId:"groups"===this.branch?t:void 0},s)).then((function(e){return n.updateAllPlaylists(t,e.playlists||[e.playlist]),e}))},t.prototype.patchPlaylists=function(t,e,i,s){return this.api.post(i,r.__assign({pid:e,groupId:"groups"===this.branch?t:void 0},s))},t.prototype.updatePlaylist=function(t,e,r){this.dispatch(t,"tracks/update_playlist",{pid:e,playlist:r})},t.prototype.updateAllPlaylists=function(t,e){return this.dispatch(t,"tracks/update_all_playlists",{playlists:e}),e},t.prototype.addExternalPlaylists=function(t,e){return this.dispatch(t,"tracks/update_all_playlists",{playlists:e}),e},t.prototype.get=function(t){return this.store.getState()[this.branch][t]||_t},t.prototype.request=function(t,e,r){return this.api.get("my",{pid:t,ctx:e,start:r,count:100,extCount:r?0:18})},t.prototype.dispatch=function(t,e,i){this.store.dispatch(r.__assign({type:e,id:String(t),branch:this.branch},i))},t}(),At=function(){function t(t,e){this.api=t,this.playlists=e}return t.prototype.getAll=function(t,e){return this.api.get("imagesV2",{pid:t,count:e})},t.prototype.update=function(t,e){var r=this.playlists.getPlaylist(t);this.playlists.update(t,{images:{imageId:e.id,imageUrl:e.url,imageCounter:r.images.imageCounter}})},t.prototype.save=function(t,e,r){return this.update(t,{id:0,url:r}),this.playlists.modify(t,"playlistsSet",{imageIds:e})},t.prototype.upload=function(t,e){var r=this,i=URL.createObjectURL(e);return this.api.post("requestImageUpload").then((function(t){var i=t.url;return r.upload0(i,e)})).then((function(e){var s=e.imageId;return r.save(t,s,i)})).catch((function(t){throw URL.revokeObjectURL(i),t}))},t.prototype.upload0=function(t,e){var r=new FormData;return r.append("file",e),this.api.post(t,r)},t}(),wt=function(t){function e(e,r,i,s){var n=t.call(this,"playlists",e,r)||this;return n.images=new At(r,n),n.library=i,n.groups=s,n}return r.__extends(e,t),e.prototype.getPlaylist=function(e){return t.prototype.get.call(this,e).playlist},e.prototype.create=function(t,e,r,i){var s=this;return(i?this.groups.createPlaylist(i,t,e):this.library.createPlaylist(t,e)).then((function(t){var e=t.newPlaylistId;return r&&s.images.upload(e,r),s.loadSimilarTracks(e),e}))},e.prototype.changeName=function(t,e){var r=this,i=this.store.getState().playlists[t].playlist;return this.update(t,{name:e}),this.modify(t,"playlistsSet",{name:e}).catch((function(e){throw r.update(t,{name:i.name}),e}))},e.prototype.modify=function(t,e,i){var s=this,n=this.store.getState().playlists[t];return this.api.post(e,r.__assign(r.__assign({pid:t},i),{excludeAllUserPlaylists:!0})).then((function(t){var e,r=t.playlist,i=null===(e=null==n?void 0:n.groupOwner)||void 0===e?void 0:e.id;return i?s.groups.updateAllPlaylists(i,[r]):s.library.updateAllPlaylists([r])}))},e.prototype.update=function(t,e){this.store.dispatch({type:"playlists/update",pid:t,playlist:e}),this.library.updatePlaylist(t,e)},e.prototype.request=function(t,e,r){return this.api.get("my",{pid:t,ctx:e,start:r,count:100,extCount:r?0:18})},e}(Tt),Pt=function(t){function e(e,r){return t.call(this,"users",e,r)||this}return r.__extends(e,t),e.prototype.reorderUserPlaylists=function(t,e,r){var s,n,a=this,o=Number(this.store.getState().currentUser.id),u=this.get(String(o)).chunkedPlaylists;if(!u)return Promise.reject();var c=u.items;this.moveUserPlaylist(o,t,r);var l=null===(s=c[r-1])||void 0===s?void 0:s.id,d=null===(n=c[r+1])||void 0===n?void 0:n.id;return this.api.get("movePlaylistBetween",{pid:t,leftId:l,rightId:d}).then((function(r){if(i.success("music.playlists-reorder",r?"success":"failed"),!r)throw a.moveUserPlaylist(o,t,e),new Error;return r}))},e.prototype.moveUserPlaylist=function(t,e,r){this.store.dispatch({type:"users/move-user-playlist",userId:t,pid:e,position:r})},e.prototype.loadMoreUserPlaylists=function(t){var e=this,r=Number(this.store.getState().currentUser.id);return this.setLoadingToUserPlaylists(r),this.api.get("userPlaylists",{start:t,count:100}).then((function(t){e.store.dispatch({type:"users/add-user-playlists",playlists:t.playlists,myPlaylists:t.value,playlistsChunk:t.playlistsChunk,userId:r})}))},e.prototype.loadMoreFriendsPlaylists=function(t,e){var r=this;this.setLoadingToUserPlaylists(e),this.api.get("my",{playlistsStart:t,playlistsCount:100,uid:e,includeTracks:!1}).then((function(t){r.store.dispatch({type:"users/add-user-playlists",playlists:t.playlists,playlistsChunk:t.playlistsChunk,userId:e})}))},e.prototype.getSubscriptions=function(t,e){return void 0===t&&(t=0),this.api.get("subscriptions",{q:e,start:t,count:100}).then((function(t){return r.ChunkedList.of(t.subscriptions||[],t.chunk)}))},e.prototype.request=function(t,e,r){return this.api.get("my",{uid:t===this.store.getState().currentUser.id?void 0:t,includePlaylists:!(t!==this.store.getState().currentUser.id&&r&&r>0),ctx:e,start:r,playlistsStart:0,playlistsCount:100,count:100,extCount:r?0:18})},e.prototype.setLoadingToUserPlaylists=function(t){this.store.dispatch({type:"users/set-loading-to-user-playlists",userId:t})},e}(Tt),Vt=function(t){function e(e,r){return t.call(this,"groups",e,r)||this}return r.__extends(e,t),e.prototype.join=function(t){return this.api.post("joinGroup",{groupId:t})},e.prototype.loadRecommended=function(t){return this.api.get("recommendGroups",{count:3,marker:t}).then((function(t){var e=r.createDataTable(t.groups),i=t.items.map((function(t){var i=t.groupRef,s=t.description,n=i.split(":")[1];return r.__assign(r.__assign({},e[n]),{description:s})}));return{groups:i,marker:t.marker}}))},e.prototype.request=function(t,e,r){void 0===r&&(r=0);var i=this.get(t),s={groupId:t,ctx:e,start:r,count:100};return r>0?this.api.get("group",s).then((function(e){return{id:Number(t),name:i.groupOwner.name,groupOwner:i.groupOwner,playCount:i.playlist.playCount,subscribed:i.subscribed,editable:i.editable,totalTracks:i.tracks.totalCount,subscribers:i.playlist.subscribers,albums:e.albums,tracks:e.tracks,chunk:e.chunk,playlists:i.playlists}})):this.api.get("group",s).then((function(t){return{id:t.groupId,name:t.name,playCount:0,subscribed:t.subscribed,editable:t.editable,totalTracks:t.totalTracks,subscribers:{count:t.membersCount,friendsCount:t.friendsCount,friends:t.friendsFull},albums:t.albums,tracks:t.tracks,chunk:t.chunk,playlists:t.playlists,groupOwner:{id:String(t.groupId),name:t.name,imageUrl:t.image}}}))},e}(Tt),St=function(t){function e(e,r){return t.call(this,"collections",e,r)||this}return r.__extends(e,t),e.prototype.fetchSet=function(t){return this.api.get("collections",{shortName:t,tracksPreview:!0}).then((function(t){var e=t.title,i=t.collections,s=t.albums;return{name:e,collections:i.map((function(t){return r.__assign(r.__assign({},t),{tracksPreview:r.convertTracks(t.tracksPreview||[],s)})}))}}))},e.prototype.fetchRecommended=function(){return this.api.get("collections",{editorial:!0})},e.prototype.request=function(t,e,r){return void 0===r&&(r=0),this.api.get("collection",{collectionId:t,ctx:e,start:r,count:100}).then((function(t){var e=t.collection,r=t.tracks,i=t.albums,s=t.chunk;return{id:e.id,name:e.name,playCount:e.playCount,subscribers:e.subscribers,playlistId:e.playlistId,images:{imageCounter:1,imageId:0,imageUrl:e.image},totalTracks:e.count,editable:!1,tracks:r,albums:i,chunk:s}}))},r.__decorate([r.cacheable],e.prototype,"fetchSet",null),r.__decorate([r.cacheable],e.prototype,"fetchRecommended",null),e}(Tt),It=function(){function t(t){this.api=t}return t.prototype.share=function(t,e,r){return"track"===t?this.api.post("postStatus",{songId:e}):this.api.post("postPlaylist",{id:e,type:t,pId:r})},t}(),Ct=function(){function t(t,e,r){this.store=t,this.api=e,this.users=r}return Object.defineProperty(t.prototype,"userId",{get:function(){return this.store.getState().currentUser.id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"playlistCount",{get:function(){var t;return null===(t=this.store.getState().users[this.userId].chunkedPlaylists)||void 0===t?void 0:t.items.length},enumerable:!1,configurable:!0}),t.prototype.updatePlaylists=function(){var t,e=this;return this.api.get("playlistsGet",{start:0,count:null!==(t=this.playlistCount)&&void 0!==t?t:100}).then((function(t){return e.updateAllPlaylists(t.playlists)}))},t.prototype.getTracks=function(){return this.users.getTracks(this.userId)},t.prototype.loadTracks=function(){return this.users.loadTracks(this.userId)},t.prototype.fetchTracks=function(){return this.users.fetchTracks(this.userId)},t.prototype.fetchSimilarTracks=function(){return this.users.fetchSimilarTracks(this.userId)},t.prototype.loadSimilarTracks=function(){return this.users.loadSimilarTracks(this.userId)},t.prototype.loadHistory=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=100),this.load0("history",t,e).then((function(t){var e=t.history,i=t.tracks,s=t.albums,n=t.chunk;return e&&i?{tracks:r.ChunkedList.of(r.convertHistoryTracks(e,i,s),n)}:{tracks:r.ChunkedList.of([])}}))},t.prototype.clearHistory=function(){return this.api.post("clearHistory")},t.prototype.loadDownloads=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=100),this.load0("downloaded",t,e).then((function(t){var e=t.tracks,i=t.albums,s=t.chunk;return e?{tracks:r.ChunkedList.of(r.convertTracks(e,i),s)}:{tracks:r.ChunkedList.of([])}}))},t.prototype.editTrack=function(t,e,r,i){return this.users.editTrack(this.userId,t,e,r,i)},t.prototype.removeTrack=function(t){var e=this;return this.users.removeTrack(this.userId,t).then((function(){e.store.dispatch({type:"added_tracks/remove",id:t})}))},t.prototype.restoreTrack=function(t){return this.users.restoreTrack(this.userId,t)},t.prototype.markTrackAsRemoved=function(t){return this.users.markTrackAsRemoved(this.userId,t)},t.prototype.clearRemovedTracks=function(){this.users.clearRemovedTracks(this.userId)},t.prototype.reorderTracks=function(t,e,r){return this.users.reorderTracks(this.userId,t,e,r)},t.prototype.createPlaylist=function(t,e){var r=this;return this.users.createPlaylist(this.userId,t,e).then((function(t){return r.moveUserPlaylists(t.newPlaylistId,t.position),t}))},t.prototype.removePlaylist=function(t){return this.users.removePlaylist(this.userId,t)},t.prototype.addPlaylist=function(t){var e=this;return this.users.addPlaylist(this.userId,t).then((function(r){return e.moveUserPlaylists(t,r.position),r}))},t.prototype.movePlaylistToTheTop=function(t){var e=this;return this.users.patchThenUpdatePlaylists(this.userId,t,"playlistsBookmarkAdd",{excludeAllUserPlaylists:!0}).then((function(r){return e.moveUserPlaylists(t,r.position),r}))},t.prototype.removePlaylistBookmark=function(t){var e=this;return this.users.patchThenUpdatePlaylists(this.userId,t,"playlistsBookmarkRemove",{pid:t,excludeAllUserPlaylists:!0}).then((function(r){return e.moveUserPlaylists(t,r.position),r}))},t.prototype.updateAllPlaylists=function(t){return this.users.updateAllPlaylists(this.userId,t)},t.prototype.markPlaylistAsRead=function(t){this.users.updatePlaylist(this.userId,t,{newTracksCount:0})},t.prototype.updatePlaylist=function(t,e){this.users.updatePlaylist(this.userId,t,e)},t.prototype.moveUserPlaylists=function(t,e){this.store.dispatch({type:"users/move-user-playlist",pid:t,userId:Number(this.userId),position:e})},t.prototype.load0=function(t,e,r){return void 0===e&&(e=0),void 0===r&&(r=100),this.api.get(t,{start:e,count:r})},t}(),xt=function(){function t(t){this.api=t}return t.prototype.fetch=function(){return this.api.get("myTuners")},t.prototype.loadTracks=function(t){return this.api.get("myRadio",{tuner:t,count:300}).then((function(t){var e=t.tracks,i=t.albums;return r.ChunkedList.of(r.convertTracks(e,i))}))},r.__decorate([r.cacheable],t.prototype,"fetch",null),t}(),Ot=function(){function t(t,e){this.api=t,this.store=e}return t.prototype.getState=function(){return this.store.getState().radio},t.prototype.getRadioStations=function(){var t;return null===(t=this.getState())||void 0===t?void 0:t.radios},t.prototype.loadMoreStations=function(){var t=this.getState();t.marker&&this.loadStations(t.marker)},t.prototype.loadStations=function(t){var e=this;return this.api.get("fm",{marker:t,count:100}).then((function(i){var s,n,a=null!==(s=i.favouriteRadios)&&void 0!==s?s:[];a.forEach((function(t){return t.favourite=!0}));var o=r.__spreadArray(r.__spreadArray([],a,!0),null!==(n=i.radios)&&void 0!==n?n:[],!0).map((function(t){return r.__assign(r.__assign({},t),{uniqueId:Lt++})}));return e.store.dispatch({type:t?"radio/add":"radio/set",radios:o,marker:i.marker}),e.getState()}))},t.prototype.toggleFavourite=function(t){var e=t.id,r=t.regionId,i=t.favourite,s=t.title;return i?this.removeFromFavourite(e,r,s):this.addToFavourite(e,r,s)},t.prototype.logRadioPlay=function(t,e){this.checkStationsCount(t,e),this.api.post("playFm",{fmId:t,regionId:e})},t.prototype.addToFavourite=function(t,e,r){var s=this;return i.success("music.radio-fm","like",r),this.api.post("likeFm",{fmId:t,regionId:e}).then((function(){return s.store.dispatch({type:"radio/like",fmId:t,regionId:e})}))},t.prototype.removeFromFavourite=function(t,e,r){var s=this;return i.success("music.radio-fm","dislike",r),this.api.post("dislikeFm",{fmId:t,regionId:e}).then((function(){return s.store.dispatch({type:"radio/dislike",fmId:t,regionId:e})}))},t.prototype.checkStationsCount=function(t,e){var r=this.getRadioStations(),i=null==r?void 0:r.findIndex((function(r){return r.id===t&&r.regionId===e}));r.length-i>5&&this.loadMoreStations()},t}(),Lt=0;var qt={query:"",counts:{},results:r.ChunkedList.empty()},Et=function(){function t(t){this.api=t}return t.prototype.loadSuggests=function(t){var e=t.trim();return e?this.api.get("queryMixedSuggestions",{q:e}):Promise.resolve({})},t.prototype.loadRelevant=function(t,e,i,s){var n=e.trim();return n?this.api.get("relevant",{tabName:t,q:n,artistName:i,count:100,bmtc:3,submitted:s}).then((function(e){var i=function(t,e,i){switch(t){case"tracks":var s=e;return s.tracks?r.convertTracks(s.tracks,i):[];case"artists":return e.artists||[];case"albums":return e.albums||[];case"playlists":return e.playlists||[];default:return[]}}(t,e.section,e.albums);return{query:n,bestMatch:e.bestMatch&&Rt(e.bestMatch,e.albums),counts:e.relevantCounts,results:r.ChunkedList.of(i,e.section.chunk)}})):Promise.resolve(qt)},t.prototype.loadResults=function(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s=100);var n=e.trim();return n?this.api.get(t,{q:n,start:i,count:s}).then((function(e){return{query:n,bestMatch:e.bestMatch,counts:e.relevantCounts,results:e.chunk?jt(t,e):r.ChunkedList.of([],{})}})):Promise.resolve(qt)},t.prototype.loadHistory=function(){return this.api.get("searchHistory")},t.prototype.removeQueryFromHistory=function(t){return this.api.get("removeSearchHistory",{query:t})},t.prototype.loadQueryCompletions=function(t){return s.invoke("music/completions",{query:t})},t}();function Rt(t,e){return{album:t.album,artist:t.artist,tracks:t.tracksPreview?r.convertTracks(t.tracksPreview,e):void 0}}function jt(t,e){switch(t){case"tracks":var i=e;return r.ChunkedList.of(r.convertTracks(i.tracks,i.albums),i.chunk);case"artists":case"albums":case"playlists":return Ut(t,e);default:return r.ChunkedList.of([],{})}}function Ut(t,e){var i=e.chunk,s=e.bestMatch,n=t.slice(0,-1),a=null==s?void 0:s[n],o=e[t];if(a){o.unshift(a);var u=i.start,c=i.more;return r.ChunkedList.of(o,{start:u,count:o.length,more:c})}return r.ChunkedList.of(o,i)}var Mt=function(){function t(t){this.api=t}return t.prototype.load=function(){var t=this;return this.api.get("pop",{layout:!0,etag:this.state&&this.etag}).then((function(e){var i=e.blocks?function(t,e){return t.map((function(t){switch(t.type){case"history":case"similar_playlist_tracks":case"similar_artist_tracks":return{id:Ht(),type:t.type,header:t.header,content:{tracks:r.convertTracks(t.content.tracks,e)}};case"top_tracks_list":return{id:Ht(),type:t.type,header:t.header,content:{tuners:t.content.tuners,selected:"all",tracks:{all:r.ChunkedList.of(r.convertTracks(t.content.tracks,e))}}};case"gift":return{id:Ht(),type:t.type,header:t.header,content:r.__assign(r.__assign({},t.content),{track:r.convertTrack(t.content.track,e.find((function(e){return e.id===t.content.track.albumId})))})};case"pro":return t.content.items.forEach((function(t){t.startColor&&(t.startColor=function(t,e){void 0===e&&(e=.6);t.length>7&&(t=t.substring(0,t.length-2));var i=Math.round(255*e),s=r.padStart(i.toString(16),2,"0");return t+s}(t.startColor))})),t.id=Ht(),t;default:return t.id=Ht(),t}}))}(e.blocks,e.albums):[];return t.etag=e.etag,t.state={blocks:e.modified?i:t.state.blocks},t.state}))},t.prototype.loadPop=function(){return this.api.get("pop").then((function(t){return{tracks:r.convertTracks(t.tracks,t.albums),collections:t.collections}}))},t.prototype.loadTracks=function(t){return this.api.get("popTracks",{tuner:t}).then((function(t){var e=t.tracks,i=t.albums;return r.ChunkedList.of(r.convertTracks(e,i))}))},t.prototype.loadTopTracksTab=function(t){void 0===t&&(t="all");var e=this.state.blocks.find((function(t){return"top_tracks_list"===t.type}));if(e){var r=e.content.tracks[t];return e.content.selected=t,r?Promise.resolve(r):this.loadTracks(t).then((function(r){return e.content.tracks[t]=r,r}))}return Promise.reject()},t.prototype.hideSubscriptionBlock=function(){var t=this;return this.state.blocks=this.state.blocks.filter((function(t){return"subscription"!==t.type})),this.api.post("hideFeaturedBlock",{typeName:"subscription"}).then((function(){return t.state}))},t.prototype.reset=function(){this.state=void 0,this.etag=void 0},t}(),Nt="showcase",Dt=0;function Ht(){return"".concat(Nt,"_").concat(Dt++)}var Ft=function(){function t(t,e){this.store=t,this.api=e}return t.prototype.fetch=function(t,e){return this.api.get("custom",{ids:t,plid:e}).then((function(t){var e=t.tracks[0];if(!e)throw i.success("music.api.error","track","error.notfound"),new Error("error.notfound");return r.convertTrack(e,t.albums[0])}))},t.prototype.fetchTrackText=function(t){var e=/\r\n|\r|\n/;return this.api.get("trackText",{tid:t}).then((function(t){var i;if(null==t?void 0:t.text)return r.__assign(r.__assign({},t),{text:null===(i=t.text)||void 0===i?void 0:i.split(e)})})).catch((function(){}))},t.prototype.fetchTrackTextWithTimeline=function(t){return this.api.get("trackText",{tid:t,timestamps:!0}).then((function(t){if(null==t?void 0:t.timestamps)return t})).catch((function(){}))},t.prototype.fetchSimilarTracks=function(t){return this.api.get("similarTracksByIds",{trackIds:t,count:100}).then((function(t){return{type:t.type,items:r.convertTracks(t.tracks,t.albums)}}))},t.prototype.loadTracks=function(t,e){return this.api.get("custom",{ids:t,plid:e||"track"}).then((function(t){return r.convertTracks(t.tracks,t.albums)}))},t.prototype.loadTrack=function(t){return this.api.get("track",{id:t}).then((function(t){return{track:r.convertTrack(t.track,t.albums),similarTracks:{type:t.type,items:r.convertTracks(t.tracks,t.albums)}}}))},t.prototype.add=function(t,e,s){var n=this,a=!0;Array.isArray(t)||("string"==typeof t.id&&(t.id=Number(t.id)),a="name"in t,t=[t]);var o=this.store.getState(),u=e?"playlists":"users",c=e?String(e):o.currentUser.id;return a&&this.store.dispatch({type:"tracks/add_tracks",branch:u,id:c,tracks:t}),this.api.post("like",{pid:e,ctx:t[0].ctx,tid:t.map((function(t){return t.id})).reverse().join(","),count:t.length,similarTracksCount:s}).then((function(e){var s=r.convertTracks(e.tracks,e.albums),a=e.similarTracks?r.convertTracks(e.similarTracks,e.albums):void 0;return function(t,e){t.forEach((function(t){e&&t.id===e.id&&(Q=!0),i.success(H,"like",JSON.stringify({trackId:t.id,ctx:t.ctx,releaseId:t.releaseId,startTimestamp:Date.now(),osType:F}))}))}(s,o.player.track),n.store.dispatch({type:"tracks/add_tracks",branch:u,id:c,tracks:s,images:e.images,totalTracks:e.totalTracks}),Array.isArray(t)?n.store.dispatch({type:"added_tracks/add",tracks:t.map((function(t){return t.id}))}):"number"==typeof t.id&&n.store.dispatch({type:"added_tracks/add",tracks:t.id}),a}))},t.prototype.download=function(t){return this.api.get("isDownloaded",{tid:t}).then((function(t){if(t.isBought){var e="".concat(t.artist,"-").concat(t.title);return{title:e,isBought:!0,downloadUrl:"".concat(r.signURL(t.downloadUrl),"&fn=").concat(encodeURIComponent(e),".mp3")}}return t}))},r.__decorate([r.cacheable],t.prototype,"fetch",null),r.__decorate([r.cacheable],t.prototype,"fetchTrackText",null),r.__decorate([r.cacheable],t.prototype,"fetchTrackTextWithTimeline",null),r.__decorate([r.cacheable],t.prototype,"fetchSimilarTracks",null),r.__decorate([r.cacheable],t.prototype,"loadTrack",null),t}(),Qt=function(){function t(t,e){this.api=t,this.showcase=e}return t.prototype.load=function(t){return this.api.get("newbie",{count:100,marker:t})},t.prototype.select=function(t,e,r){return void 0===r&&(r=5),this.api.get("newbieSimilar",{artistId:t,marker:e,count:r})},t.prototype.submit=function(t){return this.showcase.reset(),this.api.post("newbieComplete",{artists:t.join(",")})},t}(),Bt=function(t,e){return r.__assign({type:t},e)},Jt=function(t,e){return Bt("upload/setError",{cid:t,error:e})},Kt=0,Wt=function(){function e(t,e){this.store=t,this.api=e}return e.prototype.upload=function(t,e){var r=this,i=t.map((function(t){return{cid:Kt++,status:"uploading",file:t,pid:e}}));this.store.dispatch(function(t){return Bt("upload/setUploads",{uploads:t})}(i)),i.forEach((function(t){return r.upload0(t)}))},e.prototype.retry=function(t){var e=this.store.getState().uploads.get(t);this.store.dispatch(function(t){return Bt("upload/setReset",{cid:t})}(t)),this.upload0(e)},e.prototype.remove=function(t){this.store.dispatch(function(t){return Bt("upload/setRemove",{cid:t})}(t))},e.prototype.setCompleted=function(t,e,i,s){var n=this,a=Array.from(this.store.getState().uploads.values()).find((function(e){return e.uploadId===t}));a&&("failed"===e||"ERROR"===e?this.store.dispatch(Jt(a.cid,new Error("processing"))):this.api.get("custom",{ids:i,plid:"track"}).then((function(t){var e;n.store.dispatch((e=a.cid,Bt("upload/setFinish",{cid:e}))),n.remove(a.cid),n.store.dispatch({type:"tracks/add_uploaded_tracks",id:s?String(s):n.store.getState().currentUser.id,branch:s?"playlists":"users",tracks:r.convertTracks(t.tracks,t.albums)})})))},e.prototype.upload0=function(t){var e=this,r=Date.now(),s=t.cid,n=t.file,a=t.pid;i.success("music.upload","start"),this.uploadTrack(s,n,a).catch((function(t){i.duration("music.upload.error",Date.now()-r,t),e.store.dispatch(Jt(s,t))}))},e.prototype.uploadTrack=function(t,e,r){var i=this,s=e.size;return s<5120?Promise.reject("limit_min"):s>157286400?Promise.reject("limit_max"):this.api.post("upload/init",{rnd:"".concat(Date.now()).concat(t)}).then((function(s){var n=s.uploadId;return i.store.dispatch(function(t,e){return Bt("upload/setUploadId",{cid:t,uploadId:e})}(t,n)),i.api.createURL("upload/chunked").then((function(s){return i.performUpload(e,s,t,n,r)}))}))},e.prototype.performUpload=function(e,r,i,s,n){var o=this;return new Promise((function(u,c){new Promise((function(e,r){t(["FileAPI"],(function(t){e(a(t))}),r)})).then((function(t){t.upload({url:r,data:{uploadId:s,pid:n},files:{audio:e},chunkSize:1*t.MB,chunkUploadRetry:5,fileupload:function(e){return t.log("Start upload ".concat(e.name))},progress:function(t){var e=Math.min(1,t.loaded/t.total);o.store.dispatch(function(t,e){return Bt("upload/setProgress",{cid:t,progress:e})}(i,e))},filecomplete:function(e,r,i){e&&"OK"!==e?(t.log("Upload ".concat(i.name," failed with ").concat(e)),c(e)):(t.log("Upload ".concat(i.name," done")),u())}})}))}))},e}(),Xt=function(){function t(t){this.store=t}return t.prototype.updateSubscriptionStatus=function(){this.store.dispatch({type:"current_user/update_subscription_status",subscribed:!0})},t}(),Yt=function(){function t(t,e,r,i,s,n,a,o,u,c,l){this.api=t,this.artists=e,this.albums=r,this.playlists=i,this.users=s,this.groups=n,this.collections=a,this.tracks=o,this.library=u,this.tuners=c,this.showcase=l}return t.prototype.loadMore=function(t,e){switch(t){case 3:return this.collections.loadTracks(Number(e));case 4:return this.users.loadTracks(e);case 61:return this.groups.loadTracks(e);case 10:return this.library.loadTracks();case-26:return this.library.loadSimilarTracks();case 14:case 62:return this.playlists.loadTracks(Number(e));case 26:return this.playlists.loadSimilarTracks(Number(e));case 20:return this.artists.loadSimilarTracks(Number(e))}return Promise.reject("can-not-load")},t.prototype.fetchTracks=function(t,e,i){switch(t){case 1:return this.albums.fetchTracks(Number(e),i);case 11:return this.artists.fetchTracks(Number(e),i);case 20:return this.artists.fetchSimilarTracks(Number(e));case 14:case 62:return this.playlists.fetchTracks(Number(e),i);case 26:return this.playlists.fetchSimilarTracks(Number(e));case 4:return this.users.fetchTracks(e,i);case 61:return this.groups.fetchTracks(e,i);case 3:return this.collections.fetchTracks(Number(e),i);case 10:return this.library.fetchTracks();case-26:return this.library.fetchSimilarTracks();case 27:return this.tracks.fetch(Number(e),i).then((function(t){return r.ChunkedList.of([t])}));case-27:return this.tracks.loadTracks(e,i).then((function(t){return r.ChunkedList.of(t)}));case 55:return this.tracks.fetchSimilarTracks(Number(e)).then((function(t){var e=t.items;return r.ChunkedList.of(e)}));case 19:return this.tuners.loadTracks(e);case 8:return this.showcase.loadTracks(e);case 33:case 34:case 35:return this.api.get("chatpl",{start:e,before:100,count:100}).then((function(t){return r.ChunkedList.of(r.convertTracks(t.tracks,t.albums))}));default:return Promise.reject("not-supported-playlist-type-"+t)}},t}();function zt(t,e){return Promise.resolve({type:t,id:e})}var Gt,Zt,$t,te,ee,re=function(){function t(t){this.store=t}return t.prototype.hideBanner=function(t){this.store.dispatch({type:"banner/hide",bannerId:t})},t}(),ie=function(){function t(t,e,r){this.store=t,this.api=e,this.users=r}return Object.defineProperty(t.prototype,"userId",{get:function(){return this.store.getState().currentUser.id},enumerable:!1,configurable:!0}),t.prototype.loadExternal=function(t,e){return this.api.get("getExternalPlaylists",{socialProvider:"VK",redirect_uri:e,authCode:t})},t.prototype.importExternalPlaylists=function(t,e){var r=this;return this.api.post("importExternalPlaylists",{statusId:t,payloads:e.join(",")}).then((function(t){return r.users.addExternalPlaylists(r.userId,t.playlists)}))},t}(),se=null!==(Gt=window.OK.musicConfiguration)&&void 0!==Gt?Gt:{},ne=null!==(te=null!==($t=null===(Zt=null===window||void 0===window?void 0:window.pageCtx)||void 0===Zt?void 0:Zt.uid)&&void 0!==$t?$t:se.uid)&&void 0!==te?te:"userId",ae=se.confJson?JSON.parse(se.confJson):{},oe=null!==(ee=se.conf)&&void 0!==ee?ee:{},ue=function(t,e,i){var s=Y(dt,function(t,e,i){return{currentUser:{id:t},configuration:r.__assign({confJson:e},i)}}(t,e,i),tt(ft));return ct={player:{volume:100,repeat:"off"},banners:{}},function(t){try{var e=t.getState().currentUser.id,i=localStorage.getItem(mt(e));if(i){var s=JSON.parse(i);s&&(ct.player.volume=s.player.volume,ct.player.repeat=s.player.repeat||"off",ct.banners=s.banners,t.dispatch(r.__assign({type:"app/restore"},ct)))}}catch(t){}}(s),s}(ne,ae,oe),ce=new p,le=new vt(ce),de=new kt(ce),pe=new Pt(ue,ce),he=new Ct(ue,ce,pe),fe=new Vt(ue,ce),ye=new wt(ue,ce,he,fe),me=new St(ue,ce),ge=new Ft(ue,ce),ke=new It(ce),ve=new xt(ce),be=new Ot(ce,ue),_e=new Mt(ce),Te=new Et(ce),Ae=new Qt(ce,_e),we=new Wt(ue,ce),Pe=new Xt(ue),Ve=new re(ue),Se=new ie(ue,ce,pe),Ie=new J({userId:ne,state:ue.getState().player,api:ce,logRadioPlay:be.logRadioPlay.bind(be),radioSupplier:be.getRadioStations.bind(be),queueFetcher:new Yt(ce,le,de,ye,pe,fe,me,ge,he,ve,_e),chooseNextPlaylist:function(t,e){return function(r,i){switch(r){case 10:return zt(-26);case 14:return zt(26,i);case 3:var s=t.getState().collections[i];return s&&s?zt(26,String(s.playlist.playlistId)):Promise.reject();case 11:return zt(20,i);case 27:return zt(55,i);case 1:return e.fetch(Number(i)).then((function(t){if(t.albums){var e=t.albums[0];if(e)return zt(1,String(e.id))}return Promise.reject()}));case 19:case 8:return zt(r,i);default:return Promise.reject()}}}(ue,de),isAdEnabled:ue.getState().configuration.isAdEnabled});Ie.subscribe(function(t){return function(e){t.dispatch({type:"player/update",state:e})}}(ue)),ue.subscribe(function(t){return function(){var e=t.getState();!function(t,e){try{gt(yt(e),ct)||(ct=yt(e),localStorage.setItem(t,function(t){var e={player:{volume:Math.ceil(t.player.volume),repeat:"off"!==t.player.repeat?t.player.repeat:void 0},banners:t.banners};return JSON.stringify(e)}(e)))}catch(t){}}(mt(e.currentUser.id),e)}}(ue));var Ce=!1;function xe(){Ie.restore(8)}e.albums=de,e.api=ce,e.artists=le,e.banners=Ve,e.collections=me,e.currentUser=Pe,e.getState=function(){return ue.getState()},e.groups=fe,e.importing=Se,e.init=function(){return Ce?Promise.resolve():(Ce=!0,ce.get("init",{start:0,count:100,activityCount:-1,groupRecCount:0,checkNewActivity:!0,withPlaylistsDynamicLoading:!0}).then((function(t){ue.dispatch(r.__assign(r.__assign({type:"app/init"},t),{isRU:t.region.startsWith("RU")}));var e=t.lastPlayedStatus;e?Ie.restore(e.type,e.playlistId,e.trackId).catch(xe):xe()})).catch((function(){xe(),he.updatePlaylists(),ue.dispatch({type:"app/init",userId:ne,subscribed:!1})})))},e.library=he,e.newbie=Ae,e.player=Ie,e.playlists=ye,e.radio=be,e.search=Te,e.sharing=ke,e.showcase=_e,e.store=ue,e.subscribe=function(t){return ue.subscribe(t)},e.tracks=ge,e.tuners=ve,e.uploads=we,e.users=pe}));
//# sourceMappingURL=model.w.c7e8eca1.js.map
