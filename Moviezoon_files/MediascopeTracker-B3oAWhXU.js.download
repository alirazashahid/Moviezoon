function _array_like_to_array(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _array_without_holes(arr){if(Array.isArray(arr))return _array_like_to_array(arr)}function _class_call_check(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _create_class(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _iterable_to_array(iter){if(typeof Symbol!=="undefined"&&iter[Symbol.iterator]!=null||iter["@@iterator"]!=null)return Array.from(iter)}function _non_iterable_spread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _to_consumable_array(arr){return _array_without_holes(arr)||_iterable_to_array(arr)||_unsupported_iterable_to_array(arr)||_non_iterable_spread()}function _unsupported_iterable_to_array(o,minLen){if(!o)return;if(typeof o==="string")return _array_like_to_array(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _array_like_to_array(o,minLen)}define(["OK/utils/parseJsonConf","OK/utils/vanilla","OK/metrics/utils","OK/AjaxNavigationLog","OK/logger","OK/utils/screens","OK/StatLogger"],function(d,T,m,w,D,H,$){var c={};"use strict";var v=3e4;var f=500;var u=100;var L="ms.state";var I=".ms.ok.ru";var y=window.localStorage;var P=/*#__PURE__*/function(){"use strict";function P(){var _this=this;var _this1=this;_class_call_check(this,P);this.isPlayerViaLayer=false;this.wasPlayerEndSent=false;this.shouldSendPlayerHeartbeat=false;this.layerWasJustReset=false;this.initForPage=function(e,t){_this.currentLayerId=OK.Layers.getTopLayerId();_this.refreshActivityTypes();OK.Layers.subscribeGlobal(_this.onLayerToggle);_this.debugLog("Init finished! Current stateId: ".concat(_this.currentStateId));_this.processState(e,t)};this.initForPlayer=function(e){_this.lastPlayerLogTimestamp=e;_this.shouldSendPlayerHeartbeat=true;document.addEventListener("__videoPlayerEvent",_this.onVideoPlayerEvent);document.addEventListener("adv",_this.onVideoPlayerEvent)};this.onLayerToggle=function(){var e=_this.currentActivityType;var t=OK.Layers.getTopLayerId();_this.layerWasJustReset=false;if(t===null){setTimeout(function(){if(!_this.layerWasJustReset){_this.prevLayerId=_this.currentLayerId;_this.currentLayerId=t}_this.performLayerChange(e)},_this.layerResetTime)}else{_this.prevLayerId=_this.currentLayerId;_this.currentLayerId=t;_this.layerWasJustReset=true;setTimeout(function(){if(_this.layerWasJustReset){_this.performLayerChange(e)}},_this.layerResetTime)}};this.onVideoPlayerEvent=function(){var e=Date.now();_this.debugLog("player event! Session will be started or extended.");if(_this.lastPlayerLogTimestamp&&!isNaN(_this.lastPlayerLogTimestamp)){var t=e-_this.lastPlayerLogTimestamp;if(t-f>=_this.pingInterval||_this.wasPlayerEndSent){_this.lastPlayerLogTimestamp=e;_this.wasPlayerEndSent=false;_this.sendHeartbeats(e,true,true)}else{_this.shouldSendPlayerHeartbeat=true}}else{_this.lastPlayerLogTimestamp=e;_this.sendHeartbeats(e,true,true)}if(!_this.playerTimerId){var t1=e-_this.lastPlayerLogTimestamp;var i=_this.pingInterval-t1;if(isNaN(t1)||t1>_this.pingInterval||t1===0){i=_this.pingInterval}_this.playerTimerId=setTimeout(function(){_this.debugLog("Video timeout expired. Will be send: ".concat(_this.shouldSendPlayerHeartbeat));if(_this.shouldSendPlayerHeartbeat){_this.lastPlayerLogTimestamp=Date.now();_this.sendHeartbeats(_this.lastPlayerLogTimestamp,false,true)}_this.playerTimerId=null},i)}};this.sendHeartbeatsTimerWrapper=function(){_this.timerId=setTimeout(function(){return _this.sendHeartbeatsTimerWrapper()},_this.pingInterval);_this.sendHeartbeats()};this.sendHeartbeats=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Date.now(),t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:false,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:false,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"";var r=_this1.formatDate(e);if(t&&_this1.prevActivityType&&!i){var h="5";var l=_this1.prevActivityType;var a=_this1.calcUrl(h,l);_this1.sendHeartbeat(a,l,h,r,s)}var n=t?"3":"4";var o=i?"PLAYER":_this1.currentActivityType;var g=_this1.calcUrl(n,o);if(i){_this1.saveVideoData(e)}else{_this1.saveData(o,e)}_this1.sendHeartbeat(g,o,n,r,s)}}_create_class(P,[{key:"activate",value:function activate(e){var _this=this;var _d_parseJsonConf=d.parseJsonConf(e,"data-core-config"),t=_d_parseJsonConf.targetHost,i=_d_parseJsonConf.storageKey,s=_d_parseJsonConf.pingInterval,r=_d_parseJsonConf.isUserAuthorized,n=_d_parseJsonConf.searchParamsToSend,o=_d_parseJsonConf.typeToId,g=_d_parseJsonConf.isOldBrowserFormatterEnabled;var h=d.parseJsonConf(e,"data-page-logging-config");var l=d.parseJsonConf(e,"data-player-logging-config");this.withPageLogging=h.withPageLogging!==void 0?h.withPageLogging:true;this.withPlayerLogging=l.withPlayerLogging!==void 0?l.withPlayerLogging:true;this.targetHost=t||I;this.storageKey=i||L;this.pingInterval=s?Number(s):v;this.isUserAuthorized=r;this.searchParamsToSend=n;this.typeToId=o;this.isOldBrowserFormatterEnabled=g;var a;if(this.withPageLogging){var b=h.currentStateId,E=h.defaultActivityType,p=h.layerResetTime,A=h.typeToStateId,S=h.typeToLayerId;this.currentStateId=b;this.layerResetTime=p?Number(p):u;this.defaultActivityType=E;this.stateIdToType=this.revertMap(A);this.layerIdToType=this.revertMap(S);a=this.restoreData();OK.loader.use("OKCustomJs",function(){_this.initForPage(a==null?void 0:a.activityType,a==null?void 0:a.timestamp)})}if(this.withPlayerLogging){this.isEmbeddedPlayer=l.isEmbeddedPlayer;a=a||this.restoreData();this.initForPlayer(a==null?void 0:a.playerTimestamp)}}},{key:"deactivate",value:function deactivate(){if(this.withPageLogging){clearInterval(this.timerId);OK.Layers.unsubscribeGlobal(this.onLayerToggle)}if(this.withPlayerLogging){clearTimeout(this.playerTimerId);this.playerTimerId=null;document.removeEventListener("__videoPlayerEvent",this.onVideoPlayerEvent);document.removeEventListener("adv",this.onVideoPlayerEvent)}}},{key:"performLayerChange",value:function performLayerChange(e){var t=this.isPlayerViaLayer;this.refreshActivityTypes();this.debugLog("layerId change! Current layerId: ".concat(this.currentLayerId,". CurrentType: ").concat(this.currentActivityType,", prevType: ").concat(e));if(this.currentActivityType!==e){this.processState(e)}if(this.withPlayerLogging&&t){this.performPlayerEnding()}}},{key:"performPlayerEnding",value:function performPlayerEnding(){var _this=this;if(this.prevLayerId&&!this.currentLayerId){setTimeout(function(){clearTimeout(_this.playerTimerId);_this.playerTimerId=null;_this.wasPlayerEndSent=true},u);var e="5";var t="PLAYER";var i=this.calcUrl(e,t);var s=this.formatDate(Date.now());this.sendHeartbeat(i,t,e,s)}}},{key:"processState",value:function processState(e,t){var i=e!==this.currentActivityType;var s=Date.now();if(i){this.prevActivityType=e;this.sendHeartbeats(s,true);this.resetTimer();return}var r;if(t&&!isNaN(t)){var n=s-t;r="Time diff: ".concat(this.formatDate(n),". Prev time: ").concat(this.formatDate(t),".");if(n>=this.pingInterval){this.sendHeartbeats(s,true,false,r);this.resetTimer()}else if(!this.timerId){this.resetTimer(this.pingInterval-n)}}else{this.sendHeartbeats(s,true);this.resetTimer()}}},{key:"refreshActivityTypes",value:function refreshActivityTypes(){var e;this.prevActivityType=this.currentActivityType;this.isPlayerViaLayer=false;if(this.currentLayerId){var t=this.layerIdToType[this.currentLayerId];if(t==null?void 0:t.length){this.isPlayerViaLayer=true;this.currentActivityType=t[0];return}this.debugLog('current layerId "'.concat(this.currentLayerId,'" is not binded to type!'));this.currentActivityType=this.defaultActivityType;return}if((e=this.stateIdToType[this.currentStateId])==null?void 0:e.length){this.currentActivityType=this.stateIdToType[this.currentStateId][0];return}this.debugLog('current stateId "'.concat(this.currentStateId,'" is not binded to type. So we fallback to it as to "other" type.'));this.currentActivityType=this.defaultActivityType}},{key:"sendHeartbeat",value:function sendHeartbeat(e,t,i,s){var r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"";this.debugLog("\n            Sending signal!\n            Activity type: ".concat(t,".\n            Session event: ").concat(i,".\n            Timestamp: ").concat(s,".\n            Url: ").concat(e,".\n            ").concat(r));T.ajax({url:e,type:"GET",isExternal:true,responseType:"text"})}},{key:"calcUrl",value:function calcUrl(e,t){var _this=this;return"https://"+[this.typeToId[t],e,this.isEmbeddedPlayer?3:2,2,this.isUserAuthorized?2:3,1].join("")+this.targetHost+(this.searchParamsToSend?"?".concat(Object.keys(this.searchParamsToSend).map(function(i){var s;return"".concat(i,"=").concat((s=_this.searchParamsToSend)==null?void 0:s[i])}).join("&")):"")}},{key:"revertMap",value:function revertMap(e){var _loop=function(i){e[i].forEach(function(s){if(t[s]){t[s].push(i)}else{t[s]=[i]}})};if(!e){return{}}var t={};for(var i in e)_loop(i);return t}},{key:"saveData",value:function saveData(e,t){try{y.setItem(this.storageKey,JSON.stringify({activityType:e,timestamp:t,playerTimestamp:this.lastPlayerLogTimestamp}))}catch(i){this.debugLog("Error while saving data to storage!")}}},{key:"saveVideoData",value:function saveVideoData(e){var t=this.restoreData()||{};if(t){t.playerTimestamp=e}y.setItem(this.storageKey,JSON.stringify(t))}},{key:"restoreData",value:function restoreData(){try{return d.parseStorageJsonConf(y,this.storageKey)}catch(e){this.debugLog("Error while restoring data from storage!");return null}}},{key:"resetTimer",value:function resetTimer(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.pingInterval;clearTimeout(this.timerId);this.timerId=setTimeout(this.sendHeartbeatsTimerWrapper,e)}},{key:"debugLog",value:function debugLog(){for(var _len=arguments.length,e=new Array(_len),_key=0;_key<_len;_key++){e[_key]=arguments[_key]}var _m;(_m=m).debugLog.apply(_m,["MediascopeTracker"].concat(_to_consumable_array(e)))}},{key:"formatDate",value:function formatDate(e){if(this.isOldBrowserFormatterEnabled){var t=new Date(e);if(isNaN(t.getTime())){this.debugLog("Invalid timestamp ".concat(e))}var i=function(o){return o<10?"0"+o:o.toString()};var s=i(t.getHours());var r=i(t.getMinutes());var n=i(t.getSeconds());return"".concat(s,":").concat(r,":").concat(n)}return new Date(e).toLocaleTimeString("ru")}}]);return P}();c.default=P;Object.defineProperty(c,"__esModule",{value:true});return c});