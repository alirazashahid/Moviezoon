define(["jquery","OK/logger","okVideoPlayerUtils","OK/utils/utils","OK/music2/app","OK/VideoPlayerEventBuses"],(function(e,t,a,n,r,i){"use strict";var o,l={UNKNOWN:"UNKNOWN",OK:"OK",ERROR:"ERROR",UPLOADING:"UPLOADING",CREATING:"CREATING",PROCESSING:"PROCESSING",ONLINE:"ONLINE",OFFLINE:"OFFLINE",LIVE_NOT_STARTED:"LIVE_NOT_STARTED",LIVE_ENDED:"LIVE_ENDED",LIVE_INTERRUPTED:"LIVE_INTERRUPTED",ON_MODERATION:"ON_MODERATION",BLOCKED:"BLOCKED",CENSORED:"CENSORED",COPYRIGHTS_RESTRICTED:"COPYRIGHTS_RESTRICTED",UNAVAILABLE:"UNAVAILABLE",LIMITED_ACCESS:"LIMITED_ACCESS"},s=D("MiniVideoPlayer"),d="no_flash_installed",c="not_found",u=null,v=null,m={},f=null,p=null,y=null,h={},I={};e(window).on("onMusicPlaying",(function(){m.isExternalPlayer?j():B(!0)}));var E=null;function g(){clearTimeout(E);var e=re();e&&e.classList.add("invisible");var t=Z();t&&t.classList.remove("__hidden")}function b(){(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen())}function _(t,a,n,r,i){var o=e("#"+a),l=e("#"+n);b(),l.length?l.empty():l=e("<div>",{class:"vp_video_error"},{id:n}).insertAfter(o);var s=e("<div/>",{class:"vp_video_stub_w"}),d=e("<div/>",{class:"vp_video_stub __na"}).appendTo(s);e("<div/>",{class:"vp_video_stub_txt",html:i||h[r]}).appendTo(d),o.addClass("invisible"),l.removeClass("invisible").append(s),t.poster&&e("<img/>",{width:"100%",src:t.poster,class:"vp-video_stub_i"}).insertBefore(s)}function P(a){a.isExternalPlayer&&e.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:a.flashvars.metadata.movie.duration,movieId:a.flashvars.metadata.movie.movieId,contentId:a.flashvars.metadata.movie.contentId,location:a.flashvars.location,providerId:a.provider,batch:[{name:"started"}]})}).fail((function(){t.error("OKVideoStart","failOG")}))}function T(e){var t=e.flashvars.metadata.movie;return!t||(!t.paymentStatus||"PAID"===t.paymentStatus)}function O(t,a,n,r){var i=t.flashvars.metadataUrl,o={};if(!i){if(!t.flashvars.metadata)return void(n&&n());o.mid=t.flashvars.metadata.movie.movieId}r&&t.flashvars.metadata?o.is="on":t.flashvars.metadata={},o["st.location"]=t.flashvars.location,function(t,a,n,r){e.ajax({url:t?decodeURIComponent(t):"/dk?cmd=videoPlayerMetadata",data:a,dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}}).done(n).fail(r)}(i,o,(function(r){r&&!r.error?(e.extend(!0,t.flashvars.metadata,r),t.blockWebrtc&&delete t.flashvars.metadata.webrtcUrl,delete t.flashvars.metadataUrl,a&&a()):n&&n()}),(function(){n&&n()}))}function C(e,t,a){var n;if(t&&e.stubEnabled)try{var r=OK.cnst.staticUrl+"res/i/video/stub.mp4";n=document.createElement("video");var i=1;if(e.verifyInline&&(i=n&&"playsInline"in n),n&&i){t.appendChild(n);var o=document.createElement("source");o.setAttribute("src",r);var l="act_video_"+Math.round(1e9*Math.random());return n.id=l,n.setAttribute("playsInline","1"),n.appendChild(o),n.load(),void n.play().then(a.bind(null,l)).catch((function(e){n&&t.removeChild(n),a(null)}))}}catch(e){n&&t.removeChild(n)}a()}function w(e,t,a){e.flashvars.metadata?("string"==typeof e.flashvars.metadata&&(e.flashvars.metadata=JSON.parse(e.flashvars.metadata)),t&&t()):O(e,t,a)}function N(e,a,n){function r(){var t,r,i="okHtml5Player",o={paths:{okHtml5Player:e.html5url}};if(requirejs.defined(i)){var l=requirejs.toUrl(i),s=requirejs.toUrl(i+".css");l!==e.html5url&&(t=s,(r=document.querySelector("link[href*='"+t+"']"))&&(r.disabled=!0,r.parentNode.removeChild(r)),requirejs.undef(i),requirejs.config(o))}else requirejs.config(o);require([i],(function(t){t.embedPlayer(a,a,e.flashvars,n)}))}if(e.okVideoPlayerEnabled){var i=function(a){r(),t.clob("error",a&&a.stack,"one-video-player",e.flashvars.metadata.movie.id)};require(["one-video-player"],(function(t){t.create(a,e,n).catch(i)}),i)}else r()}function S(t,a){require(["swfobject"],(function(n){if(!n.getObjectById(a)){var r=n.hasFlashPlayerVersion(t.minFlashVersionNewPlayer||"11.2.0")&&t.url11?t.url11:t.url,i={id:a,name:a},o={allowScriptAccess:t.asa?"always":"never",wmode:t.wmode||"opaque",allowFullScreen:!0,menu:!1,bgcolor:"#000000"},l={autoplay:!0,wmode:o.wmode,stageVideo:"direct"==o.wmode||"gpu"==o.wmode,playerId:t.playerId};t.isExternalPlayer||(l=function(e){for(var t in e)e.hasOwnProperty(t)&&"string"!=typeof e[t]&&(e[t]=encodeURIComponent(JSON.stringify(e[t])));return e}(e.extend({},t.flashvars,l))),n.embedSWF(r,a,"100%","100%","10.0.0",null,l,o,i)}})),P(t)}function k(e,t){if(document.getElementById("hook_Cfg_CurrentUser")){var a=window.location.href;a.indexOf("?")<0?a+="?":a+="&",a+="cmd=PopLayer",a+="&st.cmd="+OK.getCurrentDesktopModelId(),a+="&st.layer.cmd=PopLayerPaymentWizardOuter",a+="&st.layer.timestamp="+Date.now(),a+="&st.layer.appId="+encodeURIComponent(e.appId),a+="&st.layer.appDescription=",a+="&st.layer.appName="+encodeURIComponent(e.title),a+="&st.layer.appCode="+encodeURIComponent(e.productCode),a+="&st.layer.currency="+encodeURIComponent("OK"),a+="&st.layer.appPrice="+encodeURIComponent(e.price),a+="&st.layer.appOptions=",a+="&st.layer.appAttributes=",a+="&st.layer.appUiConf=",a+="&st.layer.callback=true",a+="&st.layer.srv=22",a+="&st.layer.appOptionCode=",a+="&st.layer.appCardOnly=off",navigateOnUrlFromJS(a),t&&OK.loader.use(["OKCustomJs"],(function(){OK.Layers.subscribe("modal_hook",(function e(a){a?t(!1):(OK.Layers.unsubscribe("modal_hook",e),t(!0))}))}))}}function L(e,t){k(e,t?function(e){e&&n.ajax({url:t}).done(n.updateBlockModelCallback)}:null)}function A(e,t){var a=Z();a&&a.call&&a.call(e,t)}function R(t,i,s,f){t.flashvars.translations=h;var I=t.flashvars.metadata;if(I&&!I.error)if(s!==u&&de())n.ajax({url:t.flashvars.metadata.movie.link.replace(/&amp;/g,"&"),data:{"st.vpl.mini":!0,"st.vpl.ipl":!0}}).done(n.updateBlockModelCallback).done((function(){de()||R(t,i,s,f)}));else{var E,g=a.dash,b=a.mp4,O=a.hls,C=a.webrtc&&!t.webrtcBrokenH264,w=a.flash.major>=10,k=!(!t.flashvars.metadata||!t.flashvars.metadata.metadataEmbedded),L=!(!t.flashvars.metadata||!t.flashvars.metadata.hlsManifestUrl),A=!(!t.flashvars.metadata||!t.flashvars.metadata.hlsMasterPlaylistUrl),x=!(!t.flashvars.metadata||!t.flashvars.metadata.liveDashManifestUrl),D=!(!t.flashvars.metadata||!t.flashvars.metadata.rtmpUrl),U=!(!t.flashvars.metadata||!t.flashvars.metadata.webrtcUrl),V=!(!t.flashvars.metadata||!t.flashvars.liveStream),F=!(!t.flashvars.metadata||!t.flashvars.metadata.emptyPlayer),K=t.flashvars.metadata.liveStreamInfo,B=t.flashvars.metadata.movie&&t.flashvars.metadata.movie.status,M=t.flashvars.metadata.movie&&t.flashvars.metadata.movie.statusText,q=t.flashvars.metadata.movie&&t.flashvars.metadata.movie.paymentStatus,G=e("#"+i),H=e("#"+s);if(u!==s&&j(),t.isExternalPlayer&&se()&&r.pause(),u=s,v=i,m=t,o=f,H.length&&"object"===H.prop("tagName").toLowerCase()&&(H.remove(),H.length=0),!H.length&&T(t)){var W=!t.useEventsForShowing||t.isExternalPlayer||!t.isHtml5Player||!!t.flashvars.autostart;G.toggleClass("invisible",W);var J=e("<div>",{id:s,class:W?"vid-card_player":"vid-card_player __hidden"}).insertAfter(G);e("<img/>",{width:"100%",src:t.poster,class:"vid-card_img vid-card_img-delayed"}).appendTo(J)}switch(F?B=l.ONLINE:!K||B!==l.ONLINE||A||x||U||V||(B=l.OFFLINE),B){case l.OK:case l.ONLINE:case l.COPYRIGHTS_RESTRICTED:case l.BLOCKED:case l.CENSORED:!F&&K&&function(){var e=parseInt(K.endTime,10),a=Date.now()+t.timeshift;if(e&&a<e){var n=~~((parseInt(K.endTime,10)-a)/1e3),r=Math.pow(2,31)-1,i=Math.min(1e3*n+3e3,r);y=setTimeout((function(){X(0,!0)}),i)}}(),q&&"PAID"!==q?_(t,i,s,B,M):function(){if(F?N(t,s,f):t.isIframePlayer?z():t.isExternalPlayer||!t.isHtml5Player?Y():x||A||D||U?U&&C?(N(t,s,f),E=1):D&&w?Y():g&&x||O&&A?(N(t,s,f),E=1):Y():k||L?Q():b?(N(t,s,f),E=1):Y(),f&&!E){var e=document.getElementById(f);e&&f.parentNode.remove(e)}}();break;case l.OFFLINE:case l.LIVE_NOT_STARTED:case l.LIVE_ENDED:case l.LIVE_INTERRUPTED:K?function(t,a,n){var r=t.flashvars.metadata,i=r.liveStreamInfo,o=r.movie.status,s=Date.now()+t.timeshift,d=parseInt(i.startTime,10);function c(e,t){var a=~~((e-t)/1e3),n=~~(a/3600),r=~~(a/60)%60,i=a%60;return(n<10?"0"+n:n)+":"+(r<10?"0"+r:r)+":"+(i<10?"0"+i:i)}function u(t,a,n,i,o){var l=e("<div/>",{class:"vp_broadcast-stub_ac button-pro"});return e("<div/>",{class:a}).appendTo(l),e("<div/>",{class:"vp_broadcast-stub_ac_tx",text:h[n]}).appendTo(l),l.on("click",(function(){OK.VideoPlayer.toggleSubscriptionFromFlash(t,r.movie.albumId,r.movie.movieId,i,(function(){l.addClass("invisible").siblings(".vp_broadcast-stub_ac").removeClass("invisible")}),o)})),l}var v=e("<div/>",{id:n,class:"vp_broadcast-stub_w"}),m=e("<div/>",{class:"vp_video_stub_w"}).appendTo(v),f=e("<div/>",{class:"vp_broadcast-stub"}).appendTo(m),y=e("<div/>",{class:"vp_broadcast-stub_tx"}).appendTo(f);if(e("<img/>",{width:"100%",src:t.poster,class:"vid-card_img"}).appendTo(v),e("#"+n).replaceWith(v),o===l.OFFLINE)y.html(h.live_stream_offline),X(t.liveRertyTimeout,!0);else if(d>s){y.html(h.live_stream_after);var I=e("<div/>",{class:"vp_broadcast-stub_time js-live-time",text:c(d,s)}).appendTo(f);if(p=setInterval((function(){if(s=Date.now()+t.timeshift,d<s)return clearInterval(p),void X(0,!0);I.text(c(d,s))}),1e3),t.notifyEnabled&&!1===r.subscribed&&(t.notifyMovieSubscription?r.movie.movieId:r.movie.albumId)){var E=e("<div/>").appendTo(f);u(t,"vp_broadcast-stub_ac_ic ic_notifications-on-w","notify","subscribe","Video_NotifyLive").appendTo(E),u(t,"vp_broadcast-stub_ac_ic ic_notifications-off-w","not-notify","unsubscribe","Video_NotNotifyLive").addClass("invisible").appendTo(E)}}else y.html(h.live_stream_ended)}(t,0,s):_(t,i,s,B,M);break;default:_(t,i,s,B,M)}}else _(t,i,s,I&&I.error||c);function z(){try{!function(e,t){var a=document.createElement("iframe");a.id=t,a.className="vid-card_player",a.width="100%",a.height="100%",a.tabIndex="0",a.frameBorder="no",a.scrolling="no",a.allowFullScreen=!0,a.setAttribute("allowfullscreen",""),a.src=e.url;var n=document.getElementById(t);n.parentNode.replaceChild(a,n),P(e)}(t,s)}catch(e){_(t,i,s,c)}}function Y(){w?S(t,s):_(t,i,s,d)}function Q(){g&&k||O&&L?(N(t,s,f),E=1):k&&w?S(t,s):b?b?(N(t,s,f),E=1):_(t,i,s,d):Y()}}function x(e){return e+"C"}function D(e){return e+"E"}function U(e,t,a){t=t||x(e.playerId),a=a||D(e.playerId),e.timeshift||(e.timeshift=e.timestamp?parseInt(e.timestamp,10)-Date.now():0),function(e){if(!e||"object"!=typeof I)return;var t=I[e];if(!(t&&t.loaderEnabled&&t.element&&t.element.querySelector))return;var a=t.element.querySelector(".js-video-loader");a&&a.classList.toggle("invisible",!0)}(t),C(e,document.getElementById(t),(function(n){w(e,(function(){R(e,t,a,n)}),(function(){_(e,t,a,c)}))}))}function V(e){return JSON.parse(e.getAttribute("data-options"))}function F(e){return e.getAttribute("data-player-container-id")}function K(e){return e.getAttribute("data-player-element-id")}function j(){u&&v&&(f&&(clearTimeout(f),f=null),p&&(clearInterval(p),p=null),y&&(clearTimeout(y),y=null),e("#"+u).remove(),e("#"+v).removeClass("invisible"),e("#"+o).remove(),u=null,v=null,o=null,m={})}function B(e){!e&&de()||A("togglePlay",!1)}function M(){A("togglePlay",!0)}function q(e){A("setVolume",e)}function G(e){A("toggleMute",e)}function H(e){A("rotate",e)}function W(e,t){A(t?"seekTime":"seek",e)}function J(e){A("changeAnnotations",e)}function z(){A("callToStream",Array.prototype.slice.call(arguments))}function Y(e){A("showProgressTip",e)}function Q(){A("hideProgressTip",null)}function X(e,t,a){a&&(m.blockWebrtc=a),f=setTimeout(O.bind(null,m,(function(){R(m,v,u,o)}),(function(){_(m,v,u,c)}),t),e||0)}function Z(){return u?document.getElementById(u):null}function $(){return u}function ee(){var e=Z();return e&&e.isPlaying&&e.isPlaying()}function te(){var e=Z();return e&&e.isEnded&&e.isEnded()}function ae(){var e=Z();return e&&e.isSilent&&e.isSilent()}function ne(){return v}function re(){return v?document.getElementById(v):null}function ie(){return re()?re().parentNode:null}function oe(){return m}function le(t,a,r,i,o,l){(function(e,t){return n.ajax({url:"/dk",data:{cmd:"videoCommand",a:"getVideoPlayerAttributes","st.vv_movieId":e,"st.location":t},dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}})})(t,o).always((function(t){(t=t||{flashvars:{}}).playerId=a||t.playerId||null,t.width=r||t.width||null,t.height=i||t.height||null;var n="string"==typeof t.error?t.error:"",o=x(t.playerId),s=D(t.playerId);!n&&t.url?(se()&&(t.flashvars.silent="1"),l&&(t=e.extend(!0,t,l)),U(t,o,s)):_(t,o,s,c)}))}function se(){return r.playing()}function de(){return u===s}document.addEventListener("__videoPlayerEvent",(function(e){e.detail&&("episodeChanged"===e.detail.name&&e.detail.data&&i.EPISODE_CHANGED.emit({movieId:e.detail.data.movieId,time:e.detail.data.value.time}),"episodeClicked"===e.detail.name&&e.detail.data&&i.EPISODE_CLICKED.emit({movieId:e.detail.data.movieId}),"adv"!==e.detail.name&&"USER_YOUTUBE"!==e.detail.data.providerId||g(),"first_frame"===e.detail.name&&g(),"started"===e.detail.name&&(E=setTimeout((function(){g()}),900)))}));var ce=function(){var e=new Promise((function(e,a){function n(e){t.success("banner.feed","alf-okvideo",e)}var r=setTimeout((function(){n("timeout"),a()}),3e3);require(["OK/alf"],(function(t){n("load"),clearTimeout(r),e(t)}),(function(){n("error"),clearTimeout(r),a()}))}));return ce=function(){return e},e};function ue(e){var t={},a=function(e,a){t.hasOwnProperty(e)||(t[e]=[]),t[e].push(a)};try{for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];"playheadReachedValue"===r.type?r.hasOwnProperty("pvalue")?a(r.type+"Percent"+r.pvalue,r.url):r.hasOwnProperty("value")&&a(r.type+"Second"+r.value,r.url):a(r.type,r.url)}}catch(e){}return t}function ve(t){var a=e(t),n=F(t),r=K(t),i=V(t),o=a.data("autostart"),l=a.data("viewportTimeout"),s=a.data("viewportPolicy"),d=a.data("isBannerVideo")||"true"===a[0].getAttribute("data-is-fla"),v=a.data("additionalLogging"),m=a.data("visiblePart"),f=a.data("useEventsForShowing");i.timeshift=i.timestamp?parseInt(i.timestamp,10)-Date.now():0,i.flashvars.isBanner=d,i.useEventsForShowing=f;var p=!0===a.data("video-loader-enabled");function y(){a.find("#"+n).length||e("<div>",{id:n,class:"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(e("<div>",{class:"vid_play"})).appendTo(a),a.find("#"+n).on("click",(function(e){e.preventDefault(),require(["OK/StickyPlayer"],(function(e){e.isActive()&&e.updateView({reset:!0})})),C(i,document.getElementById(n),(function(e){w(i,(function(){T(i)?R(i,n,r,e):function(e,t,a,n){var r=e.flashvars.metadata.paymentInfo;document.getElementById("hook_Cfg_CurrentUser")?k(r,(function(r){r&&O(e,(function(){T(e)&&R(e,t,a,n)}))})):"1"===e.flashvars.isEmbed?window.open(e.flashvars.metadata.movie.url,"_blank"):require(["OK/AuthLoginPopup"],(function(e){e.open({href:decodeURIComponent(OK.historyManager.getState())})}))}(i,n,r,e)}),(function(){_(i,n,r,c)}))}))})),o&&U(e.extend(!0,{flashvars:{autostart:1}},i),n,r),l&&s&&"NO_AUTOSTART"===s.policy&&(l=null),l&&!i.isExternalPlayer&&require(["OK/VideoAutoplayFlow"],(function(t){t.activateViewportPlayer(e.extend(!0,{},i),n,r,l,m,s,v)}));var d=fe(t);void 0!==d&&(d.videoCard={seek:function(t){null===u?U(e.extend(!0,{flashvars:{fromTime:t}},i),n,r):A("seekTime",t)}})}"object"==typeof I&&p&&n&&(I[n]={element:t,loaderEnabled:!0});var E=i.flashvars.locale||"ru";require(["PTS/video.player/"+E],(function(t){h=t["video.player"],d&&"1"!==i.flashvars.videoPixelsSupportByAlf?function(t){var a,n=t.closest(".js-video-scope");return n.length&&(n.data("id")&&(n=e("#"+n.data("id"))),n.length&&(a=n.children(".js-video-pixels").data("pixelsjson"))),a?Promise.resolve(ue(a)):ce().then((function(e){return e.findAdv(t[0])})).then((function(e){return(a=e.getVideoPixels())?ue(a):{}}))}(a).then((function(e){Object.keys(e).length>0&&(i.flashvars.pixels=e),y()}),y):y()}))}function me(t){var a=e(t),n=a.data("playerContainerId");a.data("viewportTimeout")&&require(["OK/VideoAutoplayFlow"],(function(e){e.deactivateViewportPlayer(n)})),n===v&&j(),a.off(),"object"==typeof I&&n in I&&delete I[n]}function fe(e){for(var t=e.parentNode,a=30;t!==document&&--a>0;){if(t.classList.contains("js-video-scope"))return t;t=t.parentNode}}function pe(e){var t=fe(e.target).videoCard;void 0!==t&&t.seek(parseInt(e.target.getAttribute("data-position"),10))}function ye(e,t){var a=e.videoCard;void 0!==a&&a.seek(parseInt(t,10))}function he(e){e.addEventListener("click",pe)}function Ie(e){e.removeEventListener("click",pe)}return{activate:ve,deactivate:me,createVideoPlayer:le,start:U,stop:j,pause:B,play:M,retry:X,volume:q,setMuted:G,orientation:H,seek:W,hasMiniPlayer:de,getPlayer:Z,getPlayerId:$,getContainerId:ne,getPlayerContainer:re,getPlayerContainerWrapper:ie,getOptions:oe,prolongPayment:L,isPlaying:ee,isEnded:te,isSilent:ae,createPlayerContainerId:x,createPlayerElementId:D,initTimestamp:he,destroyTimestamp:Ie,onTimestampChange:ye,changeAnnotations:J,callToStream:z,showTooltip:Y,hideTooltip:Q,extractOptions:V,extractPlayerElementId:K,extractPlayerContainerId:F,default:{activate:ve,deactivate:me,createVideoPlayer:le,start:U,stop:j,pause:B,play:M,retry:X,volume:q,setMuted:G,orientation:H,seek:W,hasMiniPlayer:de,getPlayer:Z,getPlayerId:$,getContainerId:ne,getPlayerContainer:re,getPlayerContainerWrapper:ie,getOptions:oe,prolongPayment:L,isPlaying:ee,isEnded:te,isSilent:ae,createPlayerContainerId:x,createPlayerElementId:D,initTimestamp:he,destroyTimestamp:Ie,onTimestampChange:ye,changeAnnotations:J,callToStream:z,showTooltip:Y,hideTooltip:Q,extractOptions:V,extractPlayerElementId:K,extractPlayerContainerId:F}}}));
